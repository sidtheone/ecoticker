# US-1.2 Implementation Workflow: Sub-Score Breakdown with Reasoning

**Date:** 2026-02-13
**Story:** US-1.2 — View sub-score breakdown with reasoning on topic detail page
**Complexity:** M (responsive cards + progressive disclosure + null handling + mobile collapse)
**Dependencies:** US-1.1 (DONE)
**Blocks:** US-10.1 (per-dimension feedback)

---

## User Journey Analysis (8 Journeys)

### Journey 1: Jordan (Journalist) — Power User Seeking Depth
```
Dashboard → "Amazon Deforestation: 82 BREAKING" → Click
  ↓
Topic Detail Page loads
  ↓
Sees: Overall score (82), change (+7), urgency badge ← EXISTING
  ↓
Sees: Impact Summary replaced with overallSummary ← NEW (Phase 4)
  "Amazon deforestation rates have reached critical levels with
   cascading effects across all three impact dimensions."
  ↓
Sees: Sub-Score Breakdown section ← NEW (Phase 1)
  ┌─────────────────────┬─────────────────────┬─────────────────────┐
  │ Ecological Impact   │ Health Impact        │ Economic Impact     │
  │ (40% weight)        │ (35% weight)         │ (25% weight)        │
  │ 72  SIGNIFICANT     │ 28  MODERATE         │ 58  SIGNIFICANT     │
  │ ████████░░ (orange)  │ ████░░░░░░ (yellow)   │ ██████░░░░ (orange)  │
  │ "80% of the world's │ "No immediate human  │ "Reef tourism       │
  │  largest coral reef │  health impact, but  │  generates $6.4B    │
  │  system affected."  │  long-term food..."  │  annually..."       │
  └─────────────────────┴─────────────────────┴─────────────────────┘
  ↓
Jordan writes: "EcoTicker rates the ecological impact of Amazon
deforestation as SIGNIFICANT (72/100), citing cascading biodiversity
effects..." ← CITABLE OUTPUT
```

### Journey 2: Casey (First-Timer) — Quick Scan
```
Shared link → Topic Detail Page
  ↓
Sees: Big score (82) + BREAKING badge → immediate "how bad" answer
  ↓
Scrolls: Three colored cards with LEVELS in plain English
  - Doesn't need reasoning — SIGNIFICANT/MODERATE/SEVERE communicates severity
  ↓
Scrolls past → Articles section
  ↓
Result: Got their answer in <5 seconds without reading reasoning
```

### Journey 3: Morgan (Sustainability Officer) — Monthly Report
```
Monthly visit → Topic Detail
  ↓
Sees: Sub-score breakdown with numbers + levels
  ↓
For report: "Ecological impact rated SIGNIFICANT (72/100) per EcoTicker"
  ↓
Reads reasoning for context: quotes specific data points
  ↓
Result: Has citable data + methodology context for quarterly deck
```

### Journey 4: Incomplete Data — Single INSUFFICIENT_DATA Dimension
```
Topic: "Deep Sea Mining" → econScore = -1
  ↓
Sub-Score Breakdown renders 3 cards:
  ┌─────────────────────┬─────────────────────┬─────────────────────┐
  │ Ecological Impact   │ Health Impact        │ Economic Impact     │
  │ (40% weight)        │ (35% weight)         │ (25% weight)        │
  │ 65  SIGNIFICANT     │ 42  MODERATE         │ N/A  No Data        │
  │ ██████░░░░ (orange)  │ ████░░░░░░ (yellow)   │ ░░░░░░░░░░ (gray)    │
  │ "Mining disrupts..."│ "Workers face..."    │ "Insufficient       │
  │                     │                      │  article data..."   │
  └─────────────────────┴─────────────────────┴─────────────────────┘
```

### Journey 5: All Dimensions INSUFFICIENT_DATA
```
Topic: Very new, LLM couldn't assess any dimension
  ↓
Sub-Score Breakdown section HIDDEN
  ↓
Instead shows: muted notice
  "Sub-score breakdown unavailable — insufficient article data"
  ↓
Rest of page (ScoreChart, Articles) renders normally
```

### Journey 6: No Score History (New Topic)
```
Brand new topic, no batch run yet → scoreHistory = []
  ↓
Sub-Score Breakdown section NOT RENDERED
  ↓
No notice shown (different from Journey 5 — absence vs. explicit notice)
  ↓
Page shows: score + Impact Summary + ScoreChart (empty) + Articles
```

### Journey 7: Mobile Experience (<640px)
```
Same 3 cards but STACKED (grid-cols-1)
  ↓
Each card shows: label, weight, score+level, progress bar
  ↓
Reasoning COLLAPSED by default
  ↓
"Show reasoning ▼" button visible below progress bar
  ↓
Tap → reasoning expands with smooth transition
  ↓
"Hide reasoning ▲" button replaces it
  ↓
Result: Clean cards without text overload on small screens
```

### Journey 8: Dark Mode
```
All elements use dark: Tailwind variants:
  - Card bg: bg-[#f5f0e8] → dark:bg-gray-900
  - Card border: border-[#e8dfd3] → dark:border-gray-800
  - Labels: text-stone-600 → dark:text-gray-300
  - Score numbers: colored by urgency (same in both themes)
  - Progress bar track: bg-stone-200 → dark:bg-gray-700
  - Reasoning text: text-stone-500 → dark:text-gray-400
```

---

## Implementation Phases

### Phase 1: Sub-Score Breakdown Core UI
**File:** `src/app/topic/[slug]/page.tsx`
**Effort:** ~60 lines added

**Tasks:**
1. Extract latest scoreHistory entry: `const latest = scoreHistory[scoreHistory.length - 1]`
2. Define dimensions config array (eco, health, econ — ordered by weight)
3. Add Sub-Score Breakdown section between Impact Summary and ScoreChart
4. Render 3 dimension cards in `grid-cols-1 sm:grid-cols-3` responsive grid
5. Each card contains:
   - Dimension label (h4) + weight (small muted text)
   - Score number colored by `urgencyColor(scoreToUrgency(score))` + level badge pill
   - Progress bar: `width: ${score}%` with color matching severity
   - Reasoning text (2-3 sentences)

**Color mapping helper** (inline, not exported):
```typescript
const barColor = (score: number): string => {
  if (score >= 76) return "bg-red-500";
  if (score >= 51) return "bg-orange-500";
  if (score >= 26) return "bg-yellow-500";
  return "bg-green-500";
};
```

**Card order:** Ecological (40%) → Health (35%) → Economic (25%)

**Data-testids:**
- `sub-score-breakdown` — section container
- `dimension-card-eco` / `dimension-card-health` / `dimension-card-econ`
- `dimension-score-eco` / etc.
- `dimension-level-eco` / etc.
- `dimension-bar-eco` / etc.
- `dimension-reasoning-eco` / etc.

### Phase 2: Progressive Disclosure (Mobile Reasoning Toggle)
**File:** `src/app/topic/[slug]/page.tsx`
**Effort:** ~20 lines added

**Tasks:**
1. Add `expandedDimensions` state: `useState<Record<string, boolean>>({})`
2. On desktop (sm+): reasoning always visible (no toggle button)
3. On mobile (<sm): reasoning hidden by default, "Show reasoning" button visible
4. Implementation approach:
   - Reasoning text: `className="hidden sm:block"` for default desktop view
   - On mobile: conditionally show based on `expandedDimensions[key]`
   - Toggle button: `className="sm:hidden"` (only visible on mobile)
5. Toggle text: "Show reasoning ▼" / "Hide reasoning ▲"

### Phase 3: INSUFFICIENT_DATA & Edge Cases
**File:** `src/app/topic/[slug]/page.tsx`
**Effort:** ~25 lines added

**Tasks:**
1. **Guard: No scoreHistory** — if `scoreHistory.length === 0`, don't render breakdown
2. **All dimensions -1 check:**
   ```typescript
   const allInsufficient = latest.ecoScore === -1 && latest.healthScore === -1 && latest.econScore === -1;
   ```
   - If true: render notice instead of cards
   - Notice: `"Sub-score breakdown unavailable — insufficient article data"`
   - data-testid: `sub-score-unavailable`
3. **Per-dimension -1 handling** (inside card render):
   - Score display: "N/A" instead of number
   - Level badge: "No Data" in muted gray (`bg-stone-200 text-stone-500`)
   - Progress bar: empty gray bar (width: 0%)
   - Reasoning: "Insufficient article data to assess this dimension"
4. **Null level handling:** If level is null but score exists (pre-US-1.1 data), derive level from score using `scoreToUrgency()`

### Phase 4: Overall Summary Integration
**File:** `src/app/topic/[slug]/page.tsx`
**Effort:** ~5 lines changed

**Tasks:**
1. In Impact Summary section, check for `overallSummary` from latest scoreHistory
2. If available: display `overallSummary` instead of `topic.impactSummary`
3. Fallback chain: `latest?.overallSummary ?? topic.impactSummary`
4. Keep same styling and data-testid

### Phase 5: Tests
**File:** `tests/TopicDetail.test.tsx`
**Effort:** ~70 lines added (7 new tests)

**Test Cases:**

1. **`renders sub-score breakdown with three dimension cards`**
   - Mock data with valid scores + levels + reasoning
   - Assert 3 cards rendered with correct labels, scores, levels
   - Assert order: Ecological → Health → Economic

2. **`renders correct severity colors on dimension cards`**
   - Mock: eco=72 (SIGNIFICANT/orange), health=28 (MODERATE/yellow), econ=85 (SEVERE/red)
   - Assert level badges have correct text

3. **`renders reasoning text for each dimension`**
   - Mock data with reasoning strings
   - Assert reasoning text visible (desktop test, jsdom doesn't have viewport concept)

4. **`handles INSUFFICIENT_DATA for single dimension`**
   - Mock: econScore = -1
   - Assert: "N/A" displayed for econ score
   - Assert: "No Data" badge for econ
   - Assert: other 2 cards render normally

5. **`hides breakdown when all dimensions are INSUFFICIENT_DATA`**
   - Mock: all scores = -1
   - Assert: `sub-score-unavailable` notice visible
   - Assert: `sub-score-breakdown` NOT in document

6. **`hides breakdown when scoreHistory is empty`**
   - Mock: scoreHistory = []
   - Assert: `sub-score-breakdown` NOT in document

7. **`uses overallSummary instead of impactSummary when available`**
   - Mock: latest scoreHistory has overallSummary
   - Assert: overallSummary text displayed in impact summary section
   - Assert: topic.impactSummary NOT displayed

**Mock data updates:**
- Update existing `mockData` to include levels + reasoning in scoreHistory
- Add variant mock data for edge cases (INSUFFICIENT_DATA, empty history)

---

## Files Modified Summary

| File | Action | Lines | Purpose |
|------|--------|-------|---------|
| `src/app/topic/[slug]/page.tsx` | MODIFY | +110 | Sub-score breakdown, progressive disclosure, edge cases, overall summary |
| `tests/TopicDetail.test.tsx` | MODIFY | +70 | 7 new test cases |

**Total:** ~180 lines added across 2 files. No new files. No API changes. No schema changes.

---

## Pre-Implementation Checklist

- [x] US-1.1 complete — sub-scores, levels, reasoning stored in DB
- [x] API returns all needed fields (healthScore, ecoScore, econScore, levels, reasoning, overallSummary)
- [x] ScoreHistoryEntry type has all required fields
- [x] scoreToUrgency() utility available
- [x] urgencyColor() utility available
- [x] Existing tests pass (201/201)
- [ ] Run `npm run dev` to verify topic detail page works before changes

---

## Validation Plan

### Visual Validation
1. `npx drizzle-kit push && npx tsx scripts/seed.ts && npm run dev`
2. Navigate to topic detail page for a SEVERE topic (e.g., Amazon Deforestation)
3. Verify sub-score cards render with correct colors/levels/reasoning
4. Navigate to Deep Sea Mining (has INSUFFICIENT_DATA dimension)
5. Verify "N/A" card renders correctly
6. Test mobile viewport (Chrome DevTools → 375px width)
7. Verify reasoning toggle works on mobile
8. Toggle dark mode and verify all colors

### Automated Validation
1. `npx jest tests/TopicDetail.test.tsx` — all existing + new tests pass
2. `npx jest` — full suite passes (208+ tests expected)
3. `npx tsc --noEmit` — no TypeScript errors
4. `npm run build` — production build succeeds

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Mobile toggle hard to test in jsdom | Medium | Low | Test desktop rendering; manual mobile QA |
| urgencyColor mismatch with new usage | Low | Low | Reuse existing scoreToUrgency → urgencyColor chain |
| Null levels in old scoreHistory | Medium | Low | Fallback: derive from score via scoreToUrgency |
| Dark mode color issues | Low | Medium | Use existing dark: pattern from Impact Summary section |

---

## What This Story Does NOT Include
- ScoreChart toggle refactor (US-1.3 — separate story)
- Article count indicator near breakdown (US-2.1)
- Scoring methodology page (US-2.2)
- Per-dimension feedback buttons (US-10.1 — depends on this)
- New component files (everything inline in page.tsx per AC)
