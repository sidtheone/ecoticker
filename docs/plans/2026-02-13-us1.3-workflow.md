# US-1.3 Implementation Workflow: Toggle Sub-Score Trend Lines on Score History Chart

**Date:** 2026-02-13
**Story:** US-1.3 — Toggle sub-score trend lines on the score history chart
**Persona:** Morgan (Sustainability Officer) — monthly visitor needing dimension-level trends for reports
**Branch:** `v2`
**Dependencies:** US-1.1 (DONE), US-1.2 (DONE)

---

## Current State Analysis

### What Exists
- `src/components/ScoreChart.tsx` (52 lines) — renders 4 lines always visible
- `tests/ScoreChart.test.tsx` (45 lines) — 3 tests, mocks recharts
- Data: `ScoreHistoryEntry` already includes `healthScore`, `ecoScore`, `econScore` (all `number | null`)
- No API changes needed — all data already served

### Problems to Fix
1. **4 always-on lines = visual clutter** on a 256px chart
2. **Wrong colors**: Health is `#22c55e` (green) → green = "informational/good" in urgency system
3. **No toggle control** — users can't focus on a single dimension
4. **INSUFFICIENT_DATA (-1)** rendered as actual data points instead of gaps

---

## Target State

- **Default view:** Overall score line only (clean, simple)
- **3 toggle checkboxes** below chart: Health Impact, Ecological Impact, Economic Impact (all OFF)
- **Neutral dimension colors:** Overall=#ef4444, Health=#8b5cf6 (purple), Ecology=#06b6d4 (cyan), Economy=#f59e0b (amber)
- **Legend** shows dimension name + weight when toggled on: "Ecology (40%)"
- **INSUFFICIENT_DATA** entries (score = -1) → `null` in chart data → gaps via `connectNulls={false}`
- **Toggle state:** ephemeral React state (no persistence needed)

---

## Implementation Phases

### Phase 1: Refactor ScoreChart Component (~35 lines changed)

**File:** `src/components/ScoreChart.tsx`

**Changes:**
1. Add toggle state:
   ```typescript
   const [visible, setVisible] = useState({ health: false, eco: false, econ: false });
   ```

2. Define neutral color constants:
   ```typescript
   const DIMENSION_COLORS = {
     overall: "#ef4444",
     health: "#8b5cf6",
     eco: "#06b6d4",
     econ: "#f59e0b",
   } as const;
   ```

3. Transform data — convert -1 to null for chart gaps:
   ```typescript
   const data = history.map((h) => ({
     date: ...,
     score: h.score,
     health: h.healthScore === -1 ? null : h.healthScore,
     eco: h.ecoScore === -1 ? null : h.ecoScore,
     econ: h.econScore === -1 ? null : h.econScore,
   }));
   ```

4. Render sub-score `<Line>` elements conditionally (only when toggled on):
   - Remove 3 always-on sub-score lines
   - Add conditional rendering: `{visible.health && <Line ... />}`
   - Add `connectNulls={false}` to handle INSUFFICIENT_DATA gaps

5. Add toggle checkboxes below chart:
   ```tsx
   <div className="flex flex-wrap gap-3 mt-3">
     {DIMENSIONS.map(({ key, label, weight }) => (
       <label key={key} className="flex items-center gap-1.5 text-xs cursor-pointer">
         <input type="checkbox" checked={visible[key]}
           onChange={() => setVisible(v => ({ ...v, [key]: !v[key] }))} />
         <span style={{ color: DIMENSION_COLORS[key] }}>●</span>
         {label} ({weight})
       </label>
     ))}
   </div>
   ```

6. Update Tooltip formatter to show dimension labels with weights when active

**Dimensions constant (reusable):**
```typescript
const DIMENSIONS = [
  { key: "eco" as const, label: "Ecology", weight: "40%" },
  { key: "health" as const, label: "Health", weight: "35%" },
  { key: "econ" as const, label: "Economy", weight: "25%" },
];
```

### Phase 2: Update Tests (~60 lines changed)

**File:** `tests/ScoreChart.test.tsx`

**Update existing tests:**
1. `"renders all four score lines"` → rename to `"renders only overall line by default"` — assert 3 sub-score lines are NOT present
2. Add mock for checkbox rendering

**New tests:**
1. `"renders only overall line by default"` — no sub-score lines in DOM
2. `"toggles health dimension line on/off"` — click checkbox → line appears; click again → line disappears
3. `"toggles ecological dimension line on/off"` — same pattern
4. `"toggles economic dimension line on/off"` — same pattern
5. `"uses neutral colors (not urgency colors)"` — verify line stroke props match DIMENSION_COLORS
6. `"converts INSUFFICIENT_DATA (-1) to null in chart data"` — pass history with -1 scores, verify data transformation
7. `"shows dimension label with weight in toggle"` — verify "Ecology (40%)" text appears
8. `"multiple dimensions can be toggled simultaneously"` — toggle 2 dimensions, both lines present

**Test data update:**
- Add mock entry with `-1` scores for INSUFFICIENT_DATA gap testing
- Update recharts mock to capture `connectNulls` prop on Line

### Phase 3: Verify & Validate

1. Run full test suite: `npx jest`
2. TypeScript check: `npx tsc --noEmit`
3. Build check: `npm run build`
4. Manual visual QA (deferred):
   - Toggle each dimension on/off
   - Verify neutral colors (no green for Health)
   - Check -1 gaps render correctly
   - Test dark mode
   - Test mobile viewport

---

## User Journeys

### Journey 1: Morgan (Sustainability Officer) — Monthly Report
1. Opens topic detail for "Arctic Sea Ice"
2. Sees ScoreChart with single red overall line — clean, simple
3. Checks "Ecology (40%)" toggle → cyan line appears showing ecological trend
4. Sees ecology escalated from ~45 to ~72 over past quarter
5. Writes: "Ecological impact escalated from MODERATE to SIGNIFICANT over Q3"
6. Unchecks ecology, checks "Health (35%)" → sees health stayed relatively flat
7. Screenshots chart with ecology line for quarterly deck

### Journey 2: Jordan (Journalist) — Quick Trend Check
1. Arrives at topic detail, scans overall trend in ScoreChart
2. Notices overall score jumped 15 points
3. Toggles all 3 dimensions to see which one drove the spike
4. Economy line spiked → clicks through to articles about economic impact
5. Unchecks all, back to clean overall view

### Journey 3: Casey (First-Timer) — Default Experience
1. Lands on topic detail from social media link
2. Sees single-line chart — simple, not overwhelming
3. Doesn't interact with toggles — the default view answers "is it getting worse?"
4. Scrolls past to articles

### Journey 4: INSUFFICIENT_DATA Gaps
1. Topic has one dimension with -1 scores for some dates
2. User toggles that dimension on
3. Line has visible gaps where data was insufficient
4. Other dates render normally — user understands the limitation

### Journey 5: Dark Mode
1. All toggle labels use dark:text-gray-300 variants
2. Checkbox styling consistent with OS dark mode
3. Dimension colors (purple, cyan, amber) visible against dark background

---

## Files Changed Summary

| File | Action | Est. Lines |
|------|--------|-----------|
| `src/components/ScoreChart.tsx` | MODIFY | +40/-15 |
| `tests/ScoreChart.test.tsx` | MODIFY | +80/-10 |
| **Total** | | 2 files, ~+120/-25 |

## Complexity: M
- No new files, no API changes, no schema changes
- Single component refactor with toggle state
- Test expansion for new interactive behavior

## Risks
- **Recharts mock complexity:** Need to capture `connectNulls` prop and conditional line rendering in test mock
- **Tooltip formatting:** Recharts custom tooltip may need adjustment for dimension labels
- **Color accessibility:** Neutral colors must be distinguishable for colorblind users (purple/cyan/amber has good contrast)

## Definition of Done
- [ ] Only overall line renders by default
- [ ] 3 toggle checkboxes below chart, all OFF by default
- [ ] Toggling a checkbox adds/removes that dimension's line
- [ ] Neutral colors: Health=#8b5cf6, Ecology=#06b6d4, Economy=#f59e0b
- [ ] INSUFFICIENT_DATA (-1) renders as gaps (null values)
- [ ] Legend shows "Ecology (40%)" format
- [ ] All existing tests pass
- [ ] 8+ new tests covering toggles, colors, gaps
- [ ] TypeScript compiles with 0 errors
- [ ] Production build succeeds
