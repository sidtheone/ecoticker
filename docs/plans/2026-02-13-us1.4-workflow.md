# US-1.4 Implementation Workflow: Filter Dashboard by Category

**Date:** 2026-02-13
**Story:** US-1.4 — Filter dashboard by category
**Persona:** Casey (Concerned Citizen) — coastal town resident who only cares about ocean topics
**Branch:** `v2`
**Dependencies:** None (category data already in Topic objects)
**Complexity:** S

---

## Current State Analysis

### What Exists
- `src/components/TopicGrid.tsx` (83 lines) — urgency filter chips (All/Breaking/Critical/Moderate/Informational), fetches `/api/topics`
- `src/lib/types.ts` — `Category` type with 10 values: `air_quality`, `deforestation`, `ocean`, `climate`, `pollution`, `biodiversity`, `wildlife`, `energy`, `waste`, `water`
- `Topic` interface has `category: Category` field
- API: `GET /api/topics?category=X` already works server-side (validated, returns 400 on invalid)
- `tests/TopicGrid.test.tsx` (113 lines) — 8 tests covering urgency filters, loading, empty state

### Key Design Decision: Client-Side Filtering
Per AC: "derived from the fetched topics array — no extra API call." Category filtering happens in React state by filtering the topics array already fetched. This is different from urgency filtering which triggers a new API call. Rationale:
- Urgency filter: server-side (API supports it, reduces payload for large datasets)
- Category filter: client-side (topics already loaded, avoids refetch, instant UX)

### Problems to Solve
1. **No category filter UI** — users must scan all 12+ topics to find their domain
2. **Category values are snake_case** — need human-readable labels ("Air Quality" not "air_quality")
3. **Combined filtering** — urgency (server) AND category (client) must work together
4. **Empty combined results** — "Breaking" + "Ocean" might yield 0 topics
5. **Dynamic categories** — only show categories that exist in current topics (not all 10)

---

## Target State

- **Second row of filter chips** below urgency filters in TopicGrid
- **Dynamic categories:** Only categories with ≥1 topic shown (derived from fetched topics)
- **"All Categories" default:** Visually consistent with urgency "All" chip
- **Client-side filtering:** Filter `topics` array in React, no new API call
- **Combined filters:** Urgency (server-side) + Category (client-side) applied simultaneously
- **Empty state:** "No topics match these filters" with "Clear filters" link
- **Human-readable labels:** `air_quality` → "Air Quality", `ocean` → "Ocean"
- **Mobile:** Horizontal scrollable (same as urgency chips)

---

## Implementation Phases

### Phase 1: Add Category Filter State + Label Mapping (~25 lines)

**File:** `src/components/TopicGrid.tsx`

**Changes:**

1. Import `Category` type from `@/lib/types`:
   ```typescript
   import type { Topic, Urgency, Category } from "@/lib/types";
   ```

2. Add category label map (snake_case → human-readable):
   ```typescript
   const CATEGORY_LABELS: Record<Category, string> = {
     air_quality: "Air Quality",
     deforestation: "Deforestation",
     ocean: "Ocean",
     climate: "Climate",
     pollution: "Pollution",
     biodiversity: "Biodiversity",
     wildlife: "Wildlife",
     energy: "Energy",
     waste: "Waste",
     water: "Water",
   };
   ```

3. Add category filter state:
   ```typescript
   const [categoryFilter, setCategoryFilter] = useState<Category | null>(null);
   ```

4. Derive available categories from fetched topics (dynamic, sorted):
   ```typescript
   const availableCategories = Array.from(new Set(topics.map((t) => t.category))).sort();
   ```

5. Filter topics client-side before rendering:
   ```typescript
   const filteredTopics = categoryFilter
     ? topics.filter((t) => t.category === categoryFilter)
     : topics;
   ```

### Phase 2: Render Category Filter Chips (~20 lines)

**File:** `src/components/TopicGrid.tsx`

**Changes:**

1. Add category chips row below urgency filters:
   ```tsx
   {!loading && topics.length > 0 && (
     <div className="flex gap-2 mb-6 overflow-x-auto pb-1" data-testid="category-filters">
       <button
         onClick={() => setCategoryFilter(null)}
         className={/* active/inactive chip styles — same as urgency */}
         data-testid="filter-category-all"
       >
         All Categories
       </button>
       {availableCategories.map((cat) => (
         <button
           key={cat}
           onClick={() => setCategoryFilter(cat)}
           className={/* active/inactive chip styles */}
           data-testid={`filter-category-${cat}`}
         >
           {CATEGORY_LABELS[cat]}
         </button>
       ))}
     </div>
   )}
   ```

2. Use `filteredTopics` instead of `topics` in the grid render:
   ```tsx
   {filteredTopics.map((topic) => (
     <TopicCard key={topic.id} topic={topic} />
   ))}
   ```

3. Update empty state to differentiate "no data" vs "no matches":
   ```tsx
   {filteredTopics.length === 0 && !loading && topics.length > 0 ? (
     <div className="text-stone-400 dark:text-gray-500 text-center py-12" data-testid="no-matches">
       No topics match these filters.{" "}
       <button
         onClick={() => { setUrgencyFilter(null); setCategoryFilter(null); }}
         className="text-stone-600 dark:text-gray-300 underline"
         data-testid="clear-filters"
       >
         Clear filters
       </button>
     </div>
   ) : topics.length === 0 ? (
     <div ... data-testid="empty">No topics found</div>
   ) : (
     <div ... data-testid="topic-grid">
       {filteredTopics.map(...)}
     </div>
   )}
   ```

4. Reset category filter when urgency filter changes and returns different topics:
   - NOT needed per AC: "Category filter state lives in React state (lost on refresh — acceptable)"
   - Category filter should persist across urgency changes — if user selects "Ocean" then "Breaking", they want Breaking+Ocean

### Phase 3: Update Tests (~70 lines)

**File:** `tests/TopicGrid.test.tsx`

**Update mock data:**
- Ensure mockTopics have distinct categories (already: `climate`, `water`, `energy`)
- Add a 4th topic with duplicate category for testing "only unique categories shown"

**New tests (7):**

1. `"renders category filter chips derived from topic categories"` — after fetch, verify "All Categories", "Climate", "Energy", "Water" chips appear (alphabetical, only categories in data)
2. `"does not show categories not present in topics"` — no "Ocean", "Pollution" etc. chips
3. `"'All Categories' is active by default"` — verify active styling
4. `"clicking category chip filters topics client-side"` — click "Water" → only Ganges visible, fetch NOT called again
5. `"combined urgency + category filtering works"` — set urgency=breaking, category=climate → only Arctic shows
6. `"shows 'No topics match' when combined filters yield 0 results"` — urgency=breaking + category=water → 0 results → empty message
7. `"'Clear filters' resets both urgency and category"` — click clear → both null, all topics visible

**Key test pattern:** After clicking category chip, assert `fetch` was NOT called again (client-side filtering verified by checking fetch call count hasn't increased).

### Phase 4: Verify & Validate

1. Run full test suite: `npx jest`
2. TypeScript check: `npx tsc --noEmit`
3. Build check: `npm run build`
4. Manual visual QA (deferred):
   - Verify category chips appear below urgency chips
   - Test combined filtering (urgency + category)
   - Test "Clear filters" link
   - Verify mobile horizontal scroll
   - Verify dark mode styling

---

## User Journeys

### Journey 1: Casey (Coastal Resident) — Focus on Ocean
1. Lands on dashboard, sees 12 topics across multiple categories
2. Spots "All Categories" row below urgency filters
3. Clicks "Ocean" → grid instantly filters to 2 ocean topics (no loading flash)
4. Scans those 2 topics, clicks into one for details
5. Returns to dashboard — ocean filter still active

### Journey 2: Jordan (Journalist) — Breaking + Climate
1. Clicks "Breaking" urgency filter → API fetches breaking topics (server-side)
2. Sees 4 breaking topics across climate, ocean, biodiversity
3. Clicks "Climate" category → grid filters to 1 climate + breaking topic
4. Reads that topic, returns and clicks "All Categories" to see all breaking

### Journey 3: Morgan (Sustainability Officer) — No Matches
1. Clicks "Informational" urgency filter
2. Then clicks "Ocean" category
3. No informational ocean topics exist → sees "No topics match these filters"
4. Clicks "Clear filters" → both filters reset, all topics visible again

### Journey 4: Casey (Mobile) — Horizontal Scroll
1. On phone (375px), urgency chips scroll horizontally
2. Category chips also scroll horizontally in second row
3. Taps "Water" → instant filter, no layout shift

### Journey 5: Default Experience — No Interaction
1. Lands on dashboard, urgency = "All", category = "All Categories"
2. Sees all topics — no change from current behavior
3. Category chips visible but not intrusive

---

## Files Changed Summary

| File | Action | Est. Lines |
|------|--------|-----------|
| `src/components/TopicGrid.tsx` | MODIFY | +45/-5 |
| `tests/TopicGrid.test.tsx` | MODIFY | +70/-5 |
| **Total** | | 2 files, ~+115/-10 |

## Risks

- **Chip visual clutter on mobile:** Two rows of chips might feel crowded — mitigated by horizontal scroll and compact sizing
- **Category filter persistence:** When urgency changes, topics refetch. Category filter applied to new set — if selected category has no topics in new urgency, user sees empty. This is correct behavior (Journey 3).
- **Category label mapping maintenance:** If new categories added to `Category` type, must also add to `CATEGORY_LABELS`. TypeScript will catch this (Record<Category, string> enforces completeness).

## Definition of Done

- [ ] Category filter chips appear below urgency filters
- [ ] Only categories present in current topics are shown
- [ ] "All Categories" chip active by default
- [ ] Clicking category filters topics client-side (no new API call)
- [ ] Combined urgency + category filtering works
- [ ] "No topics match these filters" with "Clear filters" when 0 results
- [ ] Human-readable labels (Air Quality, not air_quality)
- [ ] All existing tests pass
- [ ] 7+ new tests covering category filtering
- [ ] TypeScript compiles with 0 errors
- [ ] Production build succeeds
