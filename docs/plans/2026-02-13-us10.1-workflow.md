# US-10.1 Implementation Workflow: Report an Inaccurate Score

**Date:** 2026-02-13
**Story:** US-10.1 — Report an inaccurate score with per-dimension targeting
**Persona:** Dashboard Visitor
**Branch:** `v2`
**Dependencies:** US-1.2 (sub-score breakdown UI — DONE)
**Complexity:** S

---

## Current State Analysis

### What Exists

- `score_feedback` table already defined in `src/db/schema.ts` with columns: `id`, `topicId` (FK), `scoreHistoryId` (FK nullable), `dimension`, `direction`, `comment`, `ipAddress` (GDPR truncated), `createdAt`.
- `scoreFeedbackRelations` linking to `topics` and `scoreHistory`.
- Topic detail page (`src/app/topic/[slug]/page.tsx`) renders sub-score breakdown cards for eco, health, econ dimensions.
- `truncateIP()` function available in `src/lib/audit-log.ts` for GDPR compliance.
- `RateLimiter` class in `src/lib/rate-limit.ts` with pre-configured limiters. Need a new one for feedback (5/hour/IP).
- Zod validation in `src/lib/validation.ts` with `validateRequest()` helper.
- No feedback API endpoint exists yet.
- No feedback UI exists on the dimension cards.

### Problems to Solve / Key Design Decisions

1. **Inline form vs. modal**: Spec says compact inline form below the dimension card. Expand on "Report" click, collapse after submit. No modal.
2. **Public endpoint**: `POST /api/feedback` is public (no auth) for low friction, but rate-limited to 5/hour/IP.
3. **IP truncation**: Must use `truncateIP()` before storing to `ip_address` column (GDPR).
4. **Dimension values**: Exactly `"health" | "ecology" | "economy" | "overall"`. Note: DB/code uses `eco`/`econ` internally but feedback uses full names for clarity.
5. **Direction values**: `"too_high" | "too_low" | "reasoning_mismatch"`.
6. **scoreHistoryId**: Link to the latest score history entry when available (for traceability).
7. **Zod schema**: Add `feedbackCreateSchema` to validation.ts.

---

## Target State

- Each sub-score card in the breakdown section has a small "Report" link.
- Clicking it expands an inline form with direction radio buttons, optional comment, and submit button.
- Submitting calls `POST /api/feedback` which validates, rate-limits, truncates IP, and inserts into `score_feedback`.
- Confirmation message replaces the form after success.
- Rate limited: 5 submissions per IP per hour.

---

## Implementation Phases

### Phase 1: Zod Validation Schema (~15 lines)

**File:** `src/lib/validation.ts`

**Changes:**

1. Add feedback creation schema:
```typescript
export const feedbackCreateSchema = z.object({
  topicId: z.number().int().positive(),
  scoreHistoryId: z.number().int().positive().nullable().optional(),
  dimension: z.enum(["health", "ecology", "economy", "overall"]),
  direction: z.enum(["too_high", "too_low", "reasoning_mismatch"]),
  comment: z.string().max(500).optional(),
});
```

### Phase 2: Rate Limiter for Feedback (~3 lines)

**File:** `src/lib/rate-limit.ts`

**Changes:**

1. Add a feedback-specific rate limiter:
```typescript
export const feedbackLimiter = new RateLimiter(60 * 60 * 1000, 5); // 5 per hour
```

### Phase 3: Feedback API Endpoint (~60 lines)

**File:** `src/app/api/feedback/route.ts`

**Changes:**

1. Create POST handler:
```typescript
import { NextRequest, NextResponse } from "next/server";
import { db } from "@/db";
import { scoreFeedback } from "@/db/schema";
import { feedbackCreateSchema, validateRequest } from "@/lib/validation";
import { feedbackLimiter } from "@/lib/rate-limit";

// GDPR: reuse truncateIP logic
function truncateIP(ip: string): string {
  if (!ip || ip === "unknown") return ip;
  if (ip.includes(".") && !ip.includes(":")) {
    const parts = ip.split(".");
    if (parts.length === 4) { parts[3] = "0"; return parts.join("."); }
  }
  if (ip.includes(":")) {
    const parts = ip.split(":");
    if (parts.length >= 3) return parts.slice(0, 3).join(":") + "::0";
  }
  return ip;
}

export async function POST(request: NextRequest) {
  try {
    // Rate limit by IP
    const rawIP =
      request.headers.get("cf-connecting-ip") ||
      request.headers.get("x-forwarded-for") ||
      request.headers.get("x-real-ip") ||
      "unknown";

    if (!feedbackLimiter.check(rawIP)) {
      const resetTime = feedbackLimiter.getResetTime(rawIP);
      return NextResponse.json(
        { error: "Rate limit exceeded. Max 5 feedback submissions per hour." },
        { status: 429, headers: { "Retry-After": String(Math.ceil((resetTime - Date.now()) / 1000)) } }
      );
    }

    const body = await request.json();
    const validation = validateRequest(feedbackCreateSchema, body);
    if (!validation.success) {
      return NextResponse.json({ error: validation.error }, { status: 400 });
    }

    const { topicId, scoreHistoryId, dimension, direction, comment } = validation.data;
    const truncatedIP = truncateIP(rawIP);

    await db.insert(scoreFeedback).values({
      topicId,
      scoreHistoryId: scoreHistoryId ?? null,
      dimension,
      direction,
      comment: comment || null,
      ipAddress: truncatedIP,
    });

    return NextResponse.json({ ok: true, message: "Thanks for your feedback" });
  } catch {
    return NextResponse.json({ error: "Internal error" }, { status: 500 });
  }
}
```

### Phase 4: Inline Feedback Form Component (~80 lines)

**File:** `src/components/FeedbackForm.tsx`

**Changes:**

1. Create a compact inline feedback form component:
```typescript
"use client";

import { useState } from "react";

interface FeedbackFormProps {
  topicId: number;
  scoreHistoryId: number | null;
  dimension: "health" | "ecology" | "economy" | "overall";
  onClose: () => void;
}

const DIRECTIONS = [
  { value: "too_high", label: "Too high" },
  { value: "too_low", label: "Too low" },
  { value: "reasoning_mismatch", label: "Reasoning doesn't match articles" },
] as const;

export default function FeedbackForm({ topicId, scoreHistoryId, dimension, onClose }: FeedbackFormProps) {
  const [direction, setDirection] = useState<string>("");
  const [comment, setComment] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [submitted, setSubmitted] = useState(false);
  const [error, setError] = useState("");

  const handleSubmit = async () => {
    if (!direction) return;
    setSubmitting(true);
    setError("");
    try {
      const res = await fetch("/api/feedback", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ topicId, scoreHistoryId, dimension, direction, comment: comment || undefined }),
      });
      if (!res.ok) {
        const data = await res.json();
        setError(data.error || "Failed to submit");
        return;
      }
      setSubmitted(true);
    } catch {
      setError("Network error");
    } finally {
      setSubmitting(false);
    }
  };

  if (submitted) {
    return (
      <div className="mt-2 text-xs text-green-600 dark:text-green-400" data-testid="feedback-thanks">
        Thanks for your feedback
      </div>
    );
  }

  // ... render: radio buttons, comment textarea, submit button, error message
}
```

### Phase 5: Integrate Feedback into Topic Detail (~20 lines)

**File:** `src/app/topic/[slug]/page.tsx`

**Changes:**

1. Import `FeedbackForm` component.
2. Add state to track which dimension's feedback form is open: `const [feedbackOpen, setFeedbackOpen] = useState<string | null>(null);`
3. Add a "Report" link below each dimension card's reasoning section:
```typescript
<button
  onClick={() => setFeedbackOpen(feedbackOpen === key ? null : key)}
  className="text-xs text-stone-400 hover:text-stone-600 dark:hover:text-gray-300 mt-1"
  data-testid={`report-btn-${key}`}
>
  Report inaccuracy
</button>
{feedbackOpen === key && (
  <FeedbackForm
    topicId={topic.id}
    scoreHistoryId={latest?.id ?? null}
    dimension={key === "eco" ? "ecology" : key === "econ" ? "economy" : key}
    onClose={() => setFeedbackOpen(null)}
  />
)}
```

### Phase 6: Verify & Validate

**Tests to write (~100 lines):**

**File:** `tests/feedback-api.test.ts`

1. POST valid feedback returns `{ ok: true }`.
2. POST with missing direction returns 400.
3. POST with invalid dimension returns 400.
4. POST with comment exceeding 500 chars returns 400.
5. Rate limit: 6th request within an hour returns 429.
6. IP is truncated before storage (mock DB insert, verify value).

**File:** `tests/FeedbackForm.test.tsx`

7. Renders radio buttons for all three directions.
8. Submit button disabled when no direction selected.
9. Shows "Thanks for your feedback" on successful submit.
10. Shows error message on failure.

**File:** `tests/TopicDetailPage.test.tsx`

11. "Report inaccuracy" link visible on dimension cards.
12. Clicking opens the feedback form inline.

---

## User Journeys

### Journey 1: Visitor — Reports a score as too high

1. Visitor views topic detail page for "Arctic Ice Melt".
2. Sees Health Impact score of 72 with reasoning.
3. Thinks the health score is inflated. Clicks "Report inaccuracy" on the health card.
4. Inline form expands below the card. Selects "Too high" radio button.
5. Optionally types: "The articles don't mention direct health impacts."
6. Clicks Submit. Form replaced by "Thanks for your feedback".

### Journey 2: Visitor — Hits rate limit

1. Visitor submits feedback on multiple topics rapidly.
2. After 5 submissions in an hour, the 6th attempt returns an error: "Rate limit exceeded."
3. Visitor sees "Retry-After" information.

---

## Files Changed Summary

| File | Action | Est. Lines |
|------|--------|------------|
| `src/lib/validation.ts` | Modify | ~15 |
| `src/lib/rate-limit.ts` | Modify | ~3 |
| `src/app/api/feedback/route.ts` | Create | ~60 |
| `src/components/FeedbackForm.tsx` | Create | ~80 |
| `src/app/topic/[slug]/page.tsx` | Modify | ~20 |
| `tests/feedback-api.test.ts` | Create | ~60 |
| `tests/FeedbackForm.test.tsx` | Create | ~60 |
| `tests/TopicDetailPage.test.tsx` | Modify | ~15 |
| **Total** | | **~313** |

## Risks

- **Spam/abuse**: Rate limit of 5/hour/IP mitigates this. Could add honeypot field later if needed.
- **IP truncation losing granularity**: By design (GDPR). Cannot identify individual abusers, only rate-limit them in-memory during their session.
- **Dimension name mapping**: Internal keys (`eco`, `econ`) vs. feedback values (`ecology`, `economy`). Must map correctly in the UI integration.

## Definition of Done

- [ ] "Report inaccuracy" link appears on each sub-score card.
- [ ] Clicking opens compact inline form with direction radios and optional comment.
- [ ] `POST /api/feedback` validates input (Zod), rate-limits (5/hour/IP), truncates IP, inserts into `score_feedback`.
- [ ] Confirmation message "Thanks for your feedback" shown after success.
- [ ] dimension values: `"health" | "ecology" | "economy" | "overall"`.
- [ ] direction values: `"too_high" | "too_low" | "reasoning_mismatch"`.
- [ ] IP truncated before storage (GDPR).
- [ ] All new tests pass; existing tests unbroken.
- [ ] TypeScript compiles cleanly; build succeeds.
