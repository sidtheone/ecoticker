# US-3.1 Implementation Workflow: Dynamic Insight Headline on Dashboard

**Date:** 2026-02-13
**Story:** US-3.1 — Show a dynamic insight headline on the dashboard so returning visitors immediately know what changed
**Persona:** Returning Visitor (attention-constrained)
**Branch:** `v2`
**Dependencies:** US-1.1 (DONE)
**Complexity:** S

---

## Current State Analysis

### What Exists
- Dashboard page at `src/app/page.tsx` — server component rendering static heading "EcoTicker" + subtitle "Environmental news impact tracker"
- `BiggestMovers` component fetches `/api/movers` independently
- `TopicGrid` component fetches `/api/topics` independently
- `scoreToUrgency()` utility in `src/lib/utils.ts` maps score (0-100) to urgency level
- Topic objects have `currentScore`, `previousScore`, `change`, `name`, `urgency` fields

### Problems to Solve / Key Design Decisions
1. **Data source:** Dashboard is a server component. The headline needs topic data. Best approach: create a new `InsightHeadline` client component that fetches `/api/topics` on mount (same as TopicGrid does). This avoids coupling and keeps the server component clean.
2. **Priority logic:** 6 rules evaluated in order — first match wins.
3. **Level transitions:** Compare `scoreToUrgency(currentScore)` vs `scoreToUrgency(previousScore)` to detect escalation/de-escalation.
4. **Branding:** "EcoTicker" must always appear (as subtitle), even when the headline is dynamic.

---

## Target State
- Static heading replaced by a dynamic `InsightHeadline` component
- Headline reflects the most important change: level escalation > de-escalation > big move > stable > no data
- "EcoTicker" always visible as smaller subtitle below the dynamic headline
- No extra API calls — uses existing `/api/topics` endpoint

---

## Implementation Phases

### Phase 1: Create InsightHeadline component (~70 lines)
**File:** `src/components/InsightHeadline.tsx`
**Changes:**
1. Create a `"use client"` component that:
   - Fetches `/api/topics` on mount
   - Computes the headline using priority logic
   - Listens for `ui-refresh` events to re-fetch
2. Headline computation function `computeHeadline(topics: Topic[]): string`:
```ts
function computeHeadline(topics: Topic[]): string {
  if (topics.length === 0) return "Environmental News Impact Tracker";

  const escalated = topics.filter(
    (t) => scoreToUrgency(t.currentScore) !== scoreToUrgency(t.previousScore)
      && urgencyRank(scoreToUrgency(t.currentScore)) > urgencyRank(scoreToUrgency(t.previousScore))
  );
  const deescalated = topics.filter(
    (t) => scoreToUrgency(t.currentScore) !== scoreToUrgency(t.previousScore)
      && urgencyRank(scoreToUrgency(t.currentScore)) < urgencyRank(scoreToUrgency(t.previousScore))
  );

  // Rule 1: Single escalation
  if (escalated.length === 1) {
    const t = escalated[0];
    return `${t.name} reached ${scoreToUrgency(t.currentScore).toUpperCase()}`;
  }
  // Rule 2: Multiple escalations
  if (escalated.length >= 2) {
    const highest = escalated.reduce((a, b) => a.currentScore > b.currentScore ? a : b);
    return `${escalated.length} topics escalated — ${highest.name} reached ${scoreToUrgency(highest.currentScore).toUpperCase()}`;
  }
  // Rule 3: De-escalation (only if no escalations)
  if (deescalated.length > 0) {
    const t = deescalated[0];
    return `${t.name} improved to ${scoreToUrgency(t.currentScore).toUpperCase()}`;
  }
  // Rule 4: Large score movement without level change
  const biggestMove = topics.reduce((a, b) => Math.abs(a.change) > Math.abs(b.change) ? a : b);
  if (Math.abs(biggestMove.change) > 10) {
    return `Biggest move: ${biggestMove.name} ${biggestMove.change > 0 ? "+" : ""}${biggestMove.change}`;
  }
  // Rule 5: Stable
  if (topics.every((t) => Math.abs(t.change) <= 5)) {
    return "All topics stable today";
  }
  // Rule 6: Fallback
  return "Environmental News Impact Tracker";
}
```
3. Helper function `urgencyRank(urgency: Urgency): number` to compare severity levels:
```ts
function urgencyRank(urgency: Urgency): number {
  switch (urgency) {
    case "informational": return 0;
    case "moderate": return 1;
    case "critical": return 2;
    case "breaking": return 3;
  }
}
```
4. Render:
```tsx
<div>
  <h1 className="text-2xl sm:text-3xl font-bold text-stone-800 dark:text-white" data-testid="insight-headline">
    {headline}
  </h1>
  <p className="text-sm sm:text-base text-stone-400 dark:text-gray-400 mt-1">EcoTicker</p>
</div>
```

### Phase 2: Update dashboard page (~3 lines)
**File:** `src/app/page.tsx`
**Changes:**
1. Replace the static `<div className="mb-8">` heading block with:
```tsx
<div className="mb-8">
  <InsightHeadline />
</div>
```
2. Add import: `import InsightHeadline from "@/components/InsightHeadline";`

### Phase 3: Export computeHeadline for testing (~2 lines)
**File:** `src/components/InsightHeadline.tsx`
**Changes:**
1. Export `computeHeadline` and `urgencyRank` as named exports so unit tests can test the logic directly without mounting the component.

### Phase 4: Add tests (~80 lines)
**File:** `tests/InsightHeadline.test.tsx`
**Changes:**
1. **Unit tests for `computeHeadline`** (pure function, no DOM needed):
   - Empty topics array returns "Environmental News Impact Tracker"
   - Single escalation: topic went from 55 to 82 → "[name] reached BREAKING"
   - Multiple escalations: 2 topics crossed levels → "2 topics escalated — [highest] reached [LEVEL]"
   - De-escalation only: topic dropped from 85 to 55 → "[name] improved to MODERATE"
   - Large move without level change: +15 within moderate → "Biggest move: [name] +15"
   - Stable: all changes <= 5 → "All topics stable today"
   - Fallback: changes between 6-10 with no level transitions → "Environmental News Impact Tracker"
2. **Component render test** (jsdom):
   - Mock fetch to return topics, verify headline renders
   - Verify "EcoTicker" subtitle always present

### Phase 5: Verify & Validate
1. Run `npx jest tests/InsightHeadline.test.tsx` — all pass
2. Run `npx jest` — full suite passes
3. Run `npm run build` — no TypeScript errors
4. Visual check: dynamic headline appears on dashboard, "EcoTicker" subtitle below

---

## User Journeys
### Journey 1: Returning Visitor — something escalated overnight
1. User opens the dashboard in the morning
2. Sees headline: "Amazon Deforestation reached BREAKING"
3. Immediately knows something urgent happened
4. Scans the grid to find the topic and clicks in for details

### Journey 2: Returning Visitor — quiet day
1. User opens the dashboard
2. Sees headline: "All topics stable today"
3. Knows nothing requires immediate attention
4. Browses at leisure

### Journey 3: Returning Visitor — good news
1. User opens the dashboard
2. Sees headline: "Delhi Air Quality improved to MODERATE"
3. Clicks in to see what caused the improvement

---

## Files Changed Summary
| File | Action | Est. Lines |
|------|--------|-----------|
| `src/components/InsightHeadline.tsx` | New component | +70 |
| `src/app/page.tsx` | Replace static heading | +2, -3 |
| `tests/InsightHeadline.test.tsx` | New test file | +80 |

## Risks
- **Duplicate API call:** InsightHeadline fetches `/api/topics` separately from TopicGrid. Acceptable for now since it's a lightweight GET and both need different timing. Could be optimized later with shared state or React cache.
- **Race condition:** If BiggestMovers/TopicGrid load before InsightHeadline, the headline might flash. Mitigated by showing a skeleton or the fallback text during loading.
- **Edge case between rules 4 and 5:** Changes of exactly 6-10 with no level transition fall through to "Environmental News Impact Tracker" — acceptable as a neutral fallback.

## Definition of Done
- [ ] `InsightHeadline` component created with priority-based headline logic
- [ ] Static heading on dashboard replaced with dynamic headline
- [ ] "EcoTicker" always visible as subtitle
- [ ] All 6 priority rules implemented and tested
- [ ] `scoreToUrgency()` used for level transition detection
- [ ] No extra API endpoints — uses existing `/api/topics`
- [ ] All existing tests pass
- [ ] New tests cover all headline priority rules + component rendering
- [ ] Build passes with no TypeScript errors
