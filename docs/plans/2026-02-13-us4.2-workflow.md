# US-4.2 Implementation Workflow: Deactivate a Topic from Tracking

**Date:** 2026-02-13
**Story:** US-4.2 — Stop tracking a topic so the dashboard stays focused
**Persona:** Alex (Power User) — wants to declutter the dashboard by hiding irrelevant topics
**Branch:** `v2`
**Dependencies:** US-4.1
**Complexity:** S

---

## Current State Analysis

### What Exists
- `topics.hidden` column already exists in schema (boolean, default false) — line 36 of `src/db/schema.ts`
- `PATCH /api/keywords/[id]` from US-4.1 toggles `active` status on keywords
- `GET /api/topics` (line 16-121 of `src/app/api/topics/route.ts`) returns all topics — does NOT filter by `hidden`
- Batch pipeline does not check `hidden` on topics
- No link between `tracked_keywords` and `topics` — keywords are search terms, topics are LLM-created entities

### Problems to Solve / Key Design Decisions
1. **GET /api/topics must filter hidden by default** — add `WHERE hidden = false` unless `?includeHidden=true` is passed
2. **Deactivating a keyword should hide associated topics** — but there is no direct FK between `tracked_keywords` and `topics`. Association is indirect via `topic_keywords` table (keywords that the LLM assigned to a topic). Strategy: when a tracked keyword is deactivated, find topics where `topic_keywords.keyword` matches the tracked keyword, and set `hidden = true` on those topics.
3. **Reactivation must unhide** — `PATCH /api/keywords/[id]` with `{ active: true }` reverses the hide
4. **Direct URL access preserved** — topic detail pages (`/topic/[slug]`) must still work for hidden topics; data is preserved, just hidden from dashboard listing
5. **Batch pipeline skips inactive keywords** — already handled by US-4.1's `loadKeywords()` which filters `active = true`

---

## Target State

- `GET /api/topics` filters out `hidden = true` by default
- `GET /api/topics?includeHidden=true` returns all topics (for admin views)
- `PATCH /api/keywords/[id]` with `{ active: false }` also sets `hidden = true` on associated topics
- `PATCH /api/keywords/[id]` with `{ active: true }` also sets `hidden = false` on associated topics
- Topic detail pages continue to work for hidden topics (no change needed)
- Inactive keywords are skipped by batch pipeline (US-4.1 already handles this)

---

## Implementation Phases

### Phase 1: Filter Hidden Topics from GET /api/topics (~10 lines)

**File:** `src/app/api/topics/route.ts`

**Changes:**
1. Parse `includeHidden` query parameter:
   ```typescript
   const includeHidden = request.nextUrl.searchParams.get("includeHidden") === "true";
   ```

2. Add hidden filter to conditions array (before the query, around line 43):
   ```typescript
   if (!includeHidden) {
     conditions.push(eq(topics.hidden, false));
   }
   ```

   This ensures public dashboard calls get only visible topics, while admin views can pass `?includeHidden=true`.

### Phase 2: Keyword Deactivation Hides Associated Topics (~30 lines)

**File:** `src/app/api/keywords/[id]/route.ts` (MODIFY — created in US-4.1)

**Changes:**
1. Import `topicKeywords` and `topics` from schema, import `sql` and `inArray` from drizzle-orm

2. After updating the keyword's active status in PATCH handler, propagate hidden state to associated topics:
   ```typescript
   // Propagate hidden state to associated topics
   const hidden = !validation.data.active;

   // Find topics associated with this keyword via topic_keywords table
   const associatedTopicIds = await db
     .select({ topicId: topicKeywords.topicId })
     .from(topicKeywords)
     .where(eq(topicKeywords.keyword, updated.keyword.toLowerCase()));

   if (associatedTopicIds.length > 0) {
     const ids = associatedTopicIds.map(r => r.topicId);
     await db.update(topics)
       .set({ hidden, updatedAt: new Date() })
       .where(inArray(topics.id, ids));

     console.log(`Set hidden=${hidden} on ${ids.length} topics for keyword "${updated.keyword}"`);
   }
   ```

3. Update audit log details to include hidden topic count:
   ```typescript
   await logSuccess(request, "update_keyword", {
     id: keywordId,
     changes: updates,
     hiddenTopics: associatedTopicIds.length,
   });
   ```

### Phase 3: Tests (~50 lines)

**File:** `tests/topics-api.test.ts` (MODIFY — add new tests)

**Changes:**
1. `"filters hidden topics by default"` — insert topic with `hidden: true`, GET /api/topics should not include it
2. `"includes hidden topics when includeHidden=true"` — same setup, add query param, verify topic is returned
3. `"hidden topic still accessible via direct slug"` — verify GET /api/topics/[slug] works for hidden topic

**File:** `tests/keywords-api.test.ts` (MODIFY — add new tests from US-4.1)

**Changes:**
4. `"deactivating keyword hides associated topics"` — PATCH keyword active=false, verify topics.hidden set to true
5. `"reactivating keyword unhides associated topics"` — PATCH keyword active=true, verify topics.hidden set to false

### Phase 4: Verify & Validate

1. Run full test suite: `npx jest`
2. TypeScript check: `npx tsc --noEmit`
3. Build check: `npm run build`
4. Manual QA (deferred):
   - Deactivate a keyword, verify its topics disappear from dashboard
   - Verify topic detail page still loads via direct URL
   - Reactivate the keyword, verify topics reappear on dashboard
   - Verify `?includeHidden=true` shows all topics

---

## User Journeys

### Journey 1: Alex — Hide a Noisy Topic
1. Dashboard shows 12 topics including "General Environmental News" (low-quality catch-all)
2. Goes to `/admin/keywords`, finds the keyword that spawned it
3. Clicks the toggle to deactivate the keyword
4. Returns to dashboard — "General Environmental News" is gone
5. Dashboard now shows 11 focused topics
6. The hidden topic is still accessible if someone has the direct URL

### Journey 2: Alex — Reactivate a Previously Hidden Topic
1. A previously deactivated keyword becomes relevant again (e.g., new wildfire season)
2. Goes to `/admin/keywords`, finds the inactive keyword (gray badge)
3. Clicks toggle to reactivate
4. Keyword status changes to "pending" (will be searched next batch run)
5. Associated topics reappear on dashboard immediately (hidden=false)

### Journey 3: Public User — Hidden Topic via Direct URL
1. User has a bookmarked URL to `/topic/old-topic-slug`
2. Topic was hidden by admin
3. Page still loads with full data — articles, scores, chart
4. Topic just does not appear in the main dashboard listing

---

## Files Changed Summary

| File | Action | Est. Lines |
|------|--------|-----------|
| `src/app/api/topics/route.ts` | MODIFY | +5 |
| `src/app/api/keywords/[id]/route.ts` | MODIFY | +25 |
| `tests/topics-api.test.ts` | MODIFY | +30 |
| `tests/keywords-api.test.ts` | MODIFY | +20 |
| **Total** | | 4 files, ~+80 |

## Risks
- **Keyword-topic association is indirect** — relies on `topic_keywords` table which stores LLM-assigned keywords (not the same as tracked search keywords). If the LLM assigns different keywords than the search term, the association may miss some topics. Mitigation: also do a fuzzy match on `topics.name` containing the keyword string.
- **Multiple keywords per topic** — a topic may be associated with multiple tracked keywords. Deactivating one keyword should not hide a topic if another active keyword also associates with it. Mitigation for v1: accept this edge case; can add smarter logic later.
- **Hidden flag persistence** — if batch creates a new topic from a reactivated keyword, it will have `hidden=false` by default (correct behavior).

## Definition of Done
- [ ] `GET /api/topics` excludes `hidden=true` topics by default
- [ ] `GET /api/topics?includeHidden=true` returns all topics
- [ ] Deactivating a keyword sets `hidden=true` on associated topics
- [ ] Reactivating a keyword sets `hidden=false` on associated topics
- [ ] Hidden topics remain accessible via direct URL (topic detail page)
- [ ] Batch pipeline skips inactive keywords (from US-4.1)
- [ ] 5+ new tests covering hidden filtering and keyword-topic propagation
- [ ] All existing tests pass
- [ ] TypeScript compiles with 0 errors
- [ ] Production build succeeds
