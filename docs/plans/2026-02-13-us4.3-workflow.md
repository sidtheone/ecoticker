# US-4.3 Implementation Workflow: View Tracked Keywords and Their Status

**Date:** 2026-02-13
**Story:** US-4.3 — View all tracked keywords and their current status for monitoring management
**Persona:** Sam (Site Administrator) — needs visibility into what the system is tracking
**Branch:** `v2`
**Dependencies:** US-4.1
**Complexity:** S

---

## Current State Analysis

### What Exists
- `/admin/keywords` page created in US-4.1 — has add form + basic keyword table
- `GET /api/keywords` from US-4.1 — returns DB keywords + env var system keywords
- Status badges (pending/active/no_results/inactive/system) already rendered in US-4.1 admin page
- `tracked_keywords` schema has: keyword, active, status, createdAt, lastSearchedAt, resultCount

### Problems to Solve / Key Design Decisions
1. **Article count per keyword** — US-4.1 stores `resultCount` on the keyword, but the acceptance criteria ask for "Article Count" column. This should show total articles fetched via that keyword across all time.
2. **Env var keywords need article counts too** — system keywords from BATCH_KEYWORDS should display article counts. Since they are not in the DB, we estimate from topic_keywords matches.
3. **Table sorting/filtering** — admin needs to quickly find keywords by status
4. **Enhanced list view** — US-4.1 creates the basic page; US-4.3 enhances it with richer data display

---

## Target State

- `/admin/keywords` table shows: Keyword, Type (system/user), Status (colored badge), Last Searched, Article Count, Actions
- Status filter dropdown: All | Pending | Active | No Results | Inactive | System
- Sortable by Last Searched date (most recent first by default)
- Env var keywords shown as "System" type with blue badge, no edit/delete actions
- Article count fetched from API (aggregated from articles table via topic_keywords linkage)
- Responsive table with dark mode support

---

## Implementation Phases

### Phase 1: Enhance GET /api/keywords with Article Counts (~25 lines)

**File:** `src/app/api/keywords/route.ts` (MODIFY — created in US-4.1)

**Changes:**
1. Add article count aggregation for DB keywords using a subquery:
   ```typescript
   const dbKeywords = await db
     .select({
       id: trackedKeywords.id,
       keyword: trackedKeywords.keyword,
       active: trackedKeywords.active,
       status: trackedKeywords.status,
       createdAt: trackedKeywords.createdAt,
       lastSearchedAt: trackedKeywords.lastSearchedAt,
       resultCount: trackedKeywords.resultCount,
       articleCount: sql<number>`COALESCE((
         SELECT COUNT(DISTINCT a.id)
         FROM topic_keywords tk
         JOIN articles a ON a.topic_id = tk.topic_id
         WHERE LOWER(tk.keyword) = LOWER(${trackedKeywords.keyword})
       ), 0)`,
     })
     .from(trackedKeywords)
     .orderBy(desc(trackedKeywords.createdAt));
   ```

2. Add article count for system keywords too:
   ```typescript
   const systemKeywords = await Promise.all(
     envKeywords.map(async (kw, i) => {
       const [countRow] = await db.select({
         count: sql<number>`COALESCE(COUNT(DISTINCT a.id), 0)`,
       }).from(topicKeywords)
         .innerJoin(articles, eq(articles.topicId, topicKeywords.topicId))
         .where(sql`LOWER(${topicKeywords.keyword}) = LOWER(${kw.trim()})`);
       return {
         id: -(i + 1),
         keyword: kw.trim(),
         active: true,
         status: "system" as const,
         type: "system" as const,
         createdAt: null,
         lastSearchedAt: null,
         resultCount: null,
         articleCount: countRow?.count || 0,
       };
     })
   );
   ```

### Phase 2: Enhance Admin Keywords Page (~60 lines)

**File:** `src/app/admin/keywords/page.tsx` (MODIFY — created in US-4.1)

**Changes:**
1. Add status filter dropdown:
   ```tsx
   const [statusFilter, setStatusFilter] = useState<string>("all");

   const filteredKeywords = keywords.filter(kw =>
     statusFilter === "all" ? true : kw.status === statusFilter
   );
   ```

2. Add filter UI above table:
   ```tsx
   <div className="flex items-center gap-4 mb-4">
     <label className="text-sm font-medium dark:text-gray-300">Filter by status:</label>
     <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)}
       className="rounded border px-3 py-1.5 text-sm dark:bg-gray-800 dark:border-gray-700">
       <option value="all">All</option>
       <option value="pending">Pending</option>
       <option value="active">Active</option>
       <option value="no_results">No Results</option>
       <option value="inactive">Inactive</option>
       <option value="system">System</option>
     </select>
     <span className="text-sm text-gray-500 dark:text-gray-400">
       {filteredKeywords.length} keyword(s)
     </span>
   </div>
   ```

3. Enhanced table with Article Count column:
   ```tsx
   <table className="w-full text-sm">
     <thead>
       <tr className="border-b dark:border-gray-700 text-left">
         <th className="py-2 px-3">Keyword</th>
         <th className="py-2 px-3">Type</th>
         <th className="py-2 px-3">Status</th>
         <th className="py-2 px-3">Last Searched</th>
         <th className="py-2 px-3 text-right">Articles</th>
         <th className="py-2 px-3 text-right">Actions</th>
       </tr>
     </thead>
     <tbody>
       {filteredKeywords.map(kw => (
         <tr key={kw.id} className="border-b dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50">
           <td className="py-2 px-3 font-mono">{kw.keyword}</td>
           <td className="py-2 px-3"><TypeBadge type={kw.type} /></td>
           <td className="py-2 px-3"><StatusBadge status={kw.status} /></td>
           <td className="py-2 px-3 text-gray-500">{formatDate(kw.lastSearchedAt)}</td>
           <td className="py-2 px-3 text-right tabular-nums">{kw.articleCount ?? "—"}</td>
           <td className="py-2 px-3 text-right">
             {kw.type !== "system" && <ActionButtons keyword={kw} />}
           </td>
         </tr>
       ))}
     </tbody>
   </table>
   ```

4. Add empty state for filtered results:
   ```tsx
   {filteredKeywords.length === 0 && (
     <div className="text-center py-8 text-gray-500 dark:text-gray-400">
       No keywords match the selected filter.
     </div>
   )}
   ```

### Phase 3: Tests (~30 lines)

**File:** `tests/keywords-api.test.ts` (MODIFY)

**Changes:**
1. `"GET /api/keywords includes article counts"` — mock DB to return keyword with joined article count, verify response includes `articleCount` field
2. `"GET /api/keywords includes system keywords from env var"` — set BATCH_KEYWORDS env, verify system keywords in response with type="system"

**File:** `tests/admin-keywords.test.tsx` (NEW)

**Changes:**
3. `"renders keyword table with all columns"` — mock fetch, verify table headers (Keyword, Type, Status, Last Searched, Articles, Actions)
4. `"filters keywords by status"` — simulate filter dropdown change, verify filtered results
5. `"system keywords have no action buttons"` — verify system type rows lack toggle/delete
6. `"displays status badges with correct colors"` — verify badge class names for each status

### Phase 4: Verify & Validate

1. Run full test suite: `npx jest`
2. TypeScript check: `npx tsc --noEmit`
3. Build check: `npm run build`
4. Manual QA (deferred):
   - Verify all columns display correctly
   - Filter by each status, verify results
   - Verify system keywords show blue badge, no actions
   - Verify article counts are accurate
   - Test dark mode rendering
   - Test mobile responsiveness (table horizontal scroll)

---

## User Journeys

### Journey 1: Sam (Admin) — Daily Monitoring Check
1. Opens `/admin/keywords`
2. Sees 15 keywords: 5 system (blue) + 10 user-added
3. Filters by "no_results" — sees 2 keywords that have never produced articles
4. Decides one is misspelled, deletes it
5. Decides the other needs more time, leaves it as-is
6. Filters by "active" — sees 8 keywords with recent results
7. Notes "coral bleaching" has 47 articles — confirms it is working well

### Journey 2: Sam — Identifying Underperforming Keywords
1. Sorts mentally by article count (column visible)
2. Notices "microplastics ocean" has only 2 articles despite being active for 2 weeks
3. Considers rewording to "microplastic pollution" for better results
4. Deactivates old keyword, adds new one

### Journey 3: Sam — Verifying System Keywords
1. Filters by "system" type
2. Sees the 5 default keywords from BATCH_KEYWORDS env var
3. Confirms they are all producing results (article count > 0)
4. Notes these cannot be edited via UI — would need env var change and redeploy

---

## Files Changed Summary

| File | Action | Est. Lines |
|------|--------|-----------|
| `src/app/api/keywords/route.ts` | MODIFY | +25 |
| `src/app/admin/keywords/page.tsx` | MODIFY | +60 |
| `tests/keywords-api.test.ts` | MODIFY | +15 |
| `tests/admin-keywords.test.tsx` | NEW | +40 |
| **Total** | | 4 files, ~+140 |

## Risks
- **Article count query performance** — joining topic_keywords + articles for each system keyword is N+1. Mitigation: system keywords are typically 5-10, so this is acceptable. If it grows, batch into a single query with GROUP BY.
- **Keyword matching accuracy** — `topic_keywords.keyword` values are LLM-assigned and may not exactly match tracked keyword strings. Mitigation: use case-insensitive LOWER() comparison (already in the query).
- **Stale article counts** — counts reflect all-time totals. No time-windowed count. Acceptable for v1; could add "last 7 days" column later.

## Definition of Done
- [ ] `GET /api/keywords` returns `articleCount` for each keyword (DB and system)
- [ ] `/admin/keywords` table shows: Keyword, Type, Status (badge), Last Searched, Article Count, Actions
- [ ] Status filter dropdown works for all 6 statuses (all/pending/active/no_results/inactive/system)
- [ ] System keywords display with "system" blue badge, no action buttons
- [ ] Empty state shown when filter returns no results
- [ ] Dark mode renders correctly
- [ ] 4+ new tests covering article counts, filtering, and component rendering
- [ ] All existing tests pass
- [ ] TypeScript compiles with 0 errors
- [ ] Production build succeeds
