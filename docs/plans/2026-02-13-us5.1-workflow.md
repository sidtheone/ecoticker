# US-5.1 Implementation Workflow: RSS Fallback News Source

**Date:** 2026-02-13
**Story:** US-5.1 ‚Äî Fall back to alternative news source when NewsAPI is unavailable
**Persona:** Site Operator (DevOps)
**Branch:** `v2`
**Dependencies:** None
**Complexity:** M

---

## Current State Analysis

### What Exists

- `scripts/batch.ts` has a `fetchNews()` function (lines 59-88) that fetches from NewsAPI only
- 15-second timeout via `AbortSignal.timeout(15000)`
- Keywords batched into groups of 4 for API efficiency
- In-memory dedup by URL before DB insert
- DB-level dedup via UNIQUE constraint on `articles.url` with `onConflictDoNothing`
- `articles.sourceType` column already exists in schema (default `'newsapi'`), but batch.ts never sets it during insert (line 679-691 ‚Äî no `sourceType` field in `.values()`)
- Placeholder comment on line 28: `// Future: RSS feed support (placeholder)`
- `NewsArticle` interface (lines 46-53): `title`, `url`, `source.name`, `description`, `urlToImage`, `publishedAt`

### Problems to Solve / Key Design Decisions

1. **RSS parsing library:** Need an RSS/Atom parser. Options: `rss-parser` (popular, 2M weekly downloads) vs `fast-xml-parser` (lightweight). Decision: use `rss-parser` ‚Äî purpose-built, handles RSS 2.0 + Atom, MIT license.
2. **Fallback trigger:** When exactly does fallback activate? Decision: NewsAPI fails if ALL keyword groups return errors OR total articles = 0 after all groups.
3. **RSS feed defaults:** EPA, NOAA, UN Environment RSS feeds must be identified and verified.
4. **Normalization:** RSS items have different field names (`link` vs `url`, `contentSnippet` vs `description`). Must map to existing `NewsArticle` interface.
5. **Logging:** Must clearly indicate which source provided articles for debugging.
6. **Both fail scenario:** If NewsAPI AND RSS both fail, must log critical error and exit WITHOUT updating any scores (to avoid stale/empty data corrupting the DB).

---

## Target State

- `fetchNews()` tries NewsAPI first; on failure, falls back to `fetchRSS()`
- RSS feeds configurable via `RSS_FEEDS` env var (comma-separated URLs)
- Default feeds: EPA newsroom, NOAA climate, UNEP news
- RSS articles normalized to `NewsArticle` interface
- `sourceType` tracked per article (`'newsapi'` or `'rss'`)
- Both-fail scenario: critical error log, clean exit
- Existing dedup (URL uniqueness) handles overlap between sources

---

## Implementation Phases

### Phase 1: Add RSS Parser Dependency (~5 lines)

**File:** `package.json`

**Changes:**

1. Install `rss-parser`:
   ```bash
   npm install rss-parser
   ```
2. Add type import in batch.ts:
   ```typescript
   import Parser from "rss-parser";
   ```

### Phase 2: RSS Fetcher Function (~60 lines)

**File:** `scripts/batch.ts`

**Changes:**

1. Add RSS config after existing config block (line 28):
   ```typescript
   const RSS_FEEDS = (
     process.env.RSS_FEEDS ||
     "https://www.epa.gov/newsreleases/search/rss,https://www.climate.gov/feeds/all,https://www.unep.org/rss.xml"
   ).split(",").filter(Boolean);
   ```

2. Add `fetchRSS()` function after `fetchNews()` (after line 88):
   ```typescript
   async function fetchRSS(): Promise<{ articles: NewsArticle[]; source: "rss" }> {
     const parser = new Parser({ timeout: 15000 });
     const allArticles: NewsArticle[] = [];

     for (const feedUrl of RSS_FEEDS) {
       try {
         console.log(`  Trying RSS feed: ${feedUrl}`);
         const feed = await parser.parseURL(feedUrl);
         for (const item of feed.items || []) {
           if (!item.link) continue;
           allArticles.push({
             title: item.title || "Untitled",
             url: item.link,
             source: { name: feed.title || new URL(feedUrl).hostname },
             description: item.contentSnippet || item.content || null,
             urlToImage: null, // RSS rarely has images in standard fields
             publishedAt: item.isoDate || item.pubDate || new Date().toISOString(),
           });
         }
         console.log(`  ‚úÖ ${feed.items?.length || 0} articles from ${feed.title || feedUrl}`);
       } catch (err) {
         console.error(`  ‚ùå RSS feed failed: ${feedUrl}`, err);
       }
     }

     // Deduplicate by URL
     const seen = new Set<string>();
     const deduped = allArticles.filter((a) => {
       if (!a.url || seen.has(a.url)) return false;
       seen.add(a.url);
       return true;
     });

     return { articles: deduped, source: "rss" };
   }
   ```

3. Refactor `fetchNews()` to return source metadata:
   ```typescript
   async function fetchNews(): Promise<{ articles: NewsArticle[]; source: "newsapi" | "rss" }> {
     // ... existing NewsAPI logic ...
     const deduped = allArticles.filter(/* existing dedup */);

     if (deduped.length > 0) {
       console.log(`‚úÖ NewsAPI returned ${deduped.length} articles`);
       return { articles: deduped, source: "newsapi" };
     }

     // Fallback to RSS
     console.warn("‚ö†Ô∏è NewsAPI returned 0 articles, falling back to RSS...");
     return fetchRSS();
   }
   ```

4. Wrap entire NewsAPI section in try-catch for network errors:
   ```typescript
   try {
     // existing NewsAPI fetch logic
   } catch (err) {
     console.error("‚ùå NewsAPI failed completely, falling back to RSS...", err);
     return fetchRSS();
   }
   ```

### Phase 3: Track Source Type in Article Inserts (~5 lines)

**File:** `scripts/batch.ts`

**Changes:**

1. Update `main()` to capture the source from `fetchNews()` return value (around line 530):
   ```typescript
   const { articles: newsArticles, source: newsSource } = await fetchNews();
   console.log(`Fetched ${newsArticles.length} articles (source: ${newsSource})`);
   ```

2. Handle both-fail scenario (after line 533):
   ```typescript
   if (newsArticles.length === 0) {
     console.error("üö® CRITICAL: Both NewsAPI and RSS returned 0 articles. Exiting without score updates.");
     await pool.end();
     process.exit(1);
   }
   ```

3. Pass `newsSource` to article insert (line 679-691), add `sourceType`:
   ```typescript
   await db
     .insert(articles)
     .values({
       topicId,
       title: a.title,
       url: a.url,
       source: a.source?.name || null,
       summary: a.description,
       imageUrl: a.urlToImage,
       sourceType: newsSource, // NEW: track data source
       publishedAt: a.publishedAt ? new Date(a.publishedAt) : null,
     })
     .onConflictDoNothing({ target: articles.url });
   ```

### Phase 4: Update Tests (~80 lines)

**File:** `tests/batch.test.ts`

**Changes:**

1. Add test: "falls back to RSS when NewsAPI returns 0 articles"
2. Add test: "falls back to RSS when NewsAPI throws network error"
3. Add test: "exits with code 1 when both NewsAPI and RSS fail"
4. Add test: "sets sourceType to 'rss' for RSS articles"
5. Add test: "sets sourceType to 'newsapi' for NewsAPI articles"
6. Add test: "normalizes RSS item fields to NewsArticle interface"

### Phase 5: Verify & Validate

1. `npx tsc --noEmit` ‚Äî no type errors
2. `npx jest tests/batch.test.ts` ‚Äî all tests pass
3. `npx jest` ‚Äî full suite passes (224+ tests)
4. Manual test with `NEWSAPI_KEY=""` to verify RSS fallback triggers
5. Verify logs clearly show source used

---

## User Journeys

### Journey 1: Site Operator ‚Äî NewsAPI outage

1. Daily cron triggers batch pipeline at 6AM UTC
2. NewsAPI returns 503 (service unavailable)
3. Pipeline logs: "NewsAPI failed completely, falling back to RSS..."
4. RSS feeds fetched from EPA, NOAA, UN Environment
5. Articles classified and scored normally
6. Operator sees in logs: "Fetched 15 articles (source: rss)"
7. Dashboard updates with fresh data despite NewsAPI outage

### Journey 2: Site Operator ‚Äî Both sources fail

1. Batch pipeline runs; NewsAPI times out
2. RSS feeds all return errors (network issue)
3. Pipeline logs: "CRITICAL: Both NewsAPI and RSS returned 0 articles"
4. Pipeline exits with code 1; no DB changes made
5. Cron reports failure; operator investigates

---

## Files Changed Summary

| File | Action | Est. Lines |
|------|--------|------------|
| `package.json` | Modify | +1 |
| `scripts/batch.ts` | Modify | +75 |
| `tests/batch.test.ts` | Modify | +80 |
| `.env.example` | Modify | +2 |

**Total estimated:** ~158 lines changed

## Risks

- **RSS feed URL stability:** EPA/NOAA/UNEP may change feed URLs without notice. Mitigated by making feeds configurable via env var.
- **RSS content quality:** RSS feeds may have less structured data than NewsAPI (missing descriptions, dates). Mitigated by null-safe normalization.
- **Rate limiting on RSS feeds:** Some feeds may rate-limit. Mitigated by 15s timeout per feed, sequential fetching.

## Definition of Done

- [ ] `fetchNews()` tries NewsAPI first, falls back to RSS on failure
- [ ] RSS feeds configurable via `RSS_FEEDS` env var with sensible defaults
- [ ] RSS articles normalized to `NewsArticle` interface
- [ ] `sourceType` set correctly (`'newsapi'` or `'rss'`) in article inserts
- [ ] Both-fail scenario: critical log + exit code 1, no DB mutations
- [ ] Logs clearly indicate which source was used
- [ ] All new and existing tests pass
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
