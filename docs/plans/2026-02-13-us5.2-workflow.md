# US-5.2 Implementation Workflow: Data Source Attribution

**Date:** 2026-02-13
**Story:** US-5.2 — Show data source attribution per article
**Persona:** Topic Researcher
**Branch:** `v2`
**Dependencies:** US-5.1 (RSS fallback sets sourceType)
**Complexity:** S

---

## Current State Analysis

### What Exists

- `articles.sourceType` column already in schema (`src/db/schema.ts` line 60): `text("source_type").default("newsapi")`
- `Article` type already has `sourceType: string` (`src/lib/types.ts` line 50)
- `ArticleList` component (`src/components/ArticleList.tsx`) displays `a.source` but does NOT display `sourceType`
- `GET /api/topics/[slug]` returns articles — need to verify it includes `sourceType` in the response
- Batch pipeline (`scripts/batch.ts` line 679-691) does NOT currently set `sourceType` in `.values()` — defaults to `'newsapi'` via schema default. US-5.1 will fix this.

### Problems to Solve / Key Design Decisions

1. **Display format:** How to show source type? Decision: append after source name with a separator and distinct styling. Example: "Reuters **· NewsAPI**" or "EPA **· RSS Feed**"
2. **Label mapping:** Raw values are `'newsapi'` and `'rss'` — display as "NewsAPI" and "RSS Feed" for readability.
3. **API response:** Verify `sourceType` is included in the topic detail API response. If not, add it.

---

## Target State

- ArticleList shows source type indicator next to source name: "Reuters · NewsAPI" or "EPA · RSS Feed"
- Source type has subtle styling (lighter text, smaller font) to avoid visual clutter
- API returns `sourceType` field for each article

---

## Implementation Phases

### Phase 1: Verify API Returns sourceType (~10 lines)

**File:** `src/app/api/topics/[slug]/route.ts`

**Changes:**

1. Check the SELECT query for articles — ensure `sourceType` is included in the response mapping:
   ```typescript
   // In the article mapping, ensure sourceType is returned:
   sourceType: row.sourceType || "newsapi",
   ```

### Phase 2: Update ArticleList Component (~15 lines)

**File:** `src/components/ArticleList.tsx`

**Changes:**

1. Add source type label helper:
   ```typescript
   function sourceTypeLabel(sourceType: string): string {
     switch (sourceType) {
       case "rss": return "RSS Feed";
       case "newsapi": return "NewsAPI";
       default: return sourceType;
     }
   }
   ```

2. Update the source display line (currently line 25) to include source type:
   ```tsx
   <div className="flex items-center gap-2 mt-1 text-xs text-gray-500">
     {a.source && <span>{a.source}</span>}
     {a.source && a.sourceType && (
       <span className="text-stone-400 dark:text-gray-500">· {sourceTypeLabel(a.sourceType)}</span>
     )}
     {a.publishedAt && (
       <span>{new Date(a.publishedAt).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })}</span>
     )}
   </div>
   ```

### Phase 3: Update Tests (~25 lines)

**File:** `tests/ArticleList.test.tsx`

**Changes:**

1. Update mock article data to include `sourceType: "newsapi"` in existing fixtures
2. Add test: "displays source type label next to source name"
   ```typescript
   it("displays source type label next to source name", () => {
     render(<ArticleList articles={[
       { id: 1, topicId: 1, title: "Test", url: "https://example.com", source: "Reuters", sourceType: "newsapi", summary: null, imageUrl: null, publishedAt: null },
     ]} />);
     expect(screen.getByText("· NewsAPI")).toBeInTheDocument();
   });
   ```
3. Add test: "displays RSS Feed label for rss sourceType"
4. Add test: "does not display source type when source is null"

### Phase 4: Verify & Validate

1. `npx tsc --noEmit` — no type errors
2. `npx jest tests/ArticleList.test.tsx` — all tests pass
3. `npx jest` — full suite passes
4. Visual check: article items show "Source · SourceType" format

---

## User Journeys

### Journey 1: Topic Researcher — Identifying data provenance

1. Researcher opens a topic detail page (e.g., "Amazon Deforestation")
2. Scrolls to Related Articles section
3. Sees: "Reuters · NewsAPI" on some articles
4. After an API outage, sees: "EPA · RSS Feed" on fallback articles
5. Researcher can quickly distinguish which source provided each article

---

## Files Changed Summary

| File | Action | Est. Lines |
|------|--------|------------|
| `src/components/ArticleList.tsx` | Modify | +15 |
| `src/app/api/topics/[slug]/route.ts` | Modify | +3 |
| `tests/ArticleList.test.tsx` | Modify | +25 |

**Total estimated:** ~43 lines changed

## Risks

- **Missing sourceType in existing data:** Articles inserted before US-5.1 will have `sourceType = 'newsapi'` (schema default), which is correct for existing data.
- **Null sourceType:** If somehow null, the label simply won't render (guarded by conditional).

## Definition of Done

- [ ] ArticleList displays source type indicator (e.g., "Reuters · NewsAPI")
- [ ] Source type uses human-readable labels ("NewsAPI", "RSS Feed")
- [ ] API response includes `sourceType` for each article
- [ ] Source type indicator has subtle, non-distracting styling
- [ ] All new and existing tests pass
- [ ] TypeScript compiles without errors
