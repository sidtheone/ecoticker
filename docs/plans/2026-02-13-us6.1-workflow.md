# US-6.1 Implementation Workflow: Social Sharing with Rich Previews

**Date:** 2026-02-13
**Story:** US-6.1 — Share a topic page with rich social previews
**Persona:** Journalist (Clara)
**Branch:** `v2`
**Dependencies:** None
**Complexity:** S

---

## Current State Analysis

### What Exists

- Topic detail page: `src/app/topic/[slug]/page.tsx` — a `"use client"` component that fetches data via client-side `fetch()`
- No `layout.tsx` in the `topic/[slug]` directory — uses root layout only
- No `generateMetadata()` anywhere for topic pages — social previews show generic site info
- Root layout (`src/app/layout.tsx`) sets basic `<title>` and metadata
- No share button on topic detail page
- DB connection available via `src/db/index.ts` (Drizzle pool) for server-side queries
- Topics table has: `name`, `slug`, `currentScore`, `urgency`, `impactSummary`, `scoreReasoning`
- No static OG image exists yet (US-6.3 will add dynamic ones)

### Problems to Solve / Key Design Decisions

1. **Server vs Client data fetching for metadata:** `page.tsx` is `"use client"` — cannot export `generateMetadata()` from a client component. Solution: create a sibling `layout.tsx` (server component) that exports `generateMetadata()` with direct DB access.
2. **OG image:** No dynamic OG image yet (US-6.3). For now, use a static fallback image. Decision: `/public/og-default.png` (1200x630 placeholder).
3. **Description text:** Use `impactSummary` or `scoreReasoning`, truncated to 200 chars.
4. **Share button UX:** Simple clipboard copy with brief toast. No external share SDK needed.
5. **Clipboard API:** Modern browsers support `navigator.clipboard.writeText()`. Fallback not needed (all modern browsers support it).

---

## Target State

- Topic pages have proper Open Graph and Twitter Card meta tags
- Social media platforms (Twitter/X, Facebook, LinkedIn, Slack) show rich previews when topic URLs are shared
- "Share" button on topic detail page copies URL to clipboard with "Link copied!" confirmation
- Page `<title>` includes topic name and score

---

## Implementation Phases

### Phase 1: Create Static OG Fallback Image (~0 lines code)

**File:** `public/og-default.png`

**Changes:**

1. Create a simple 1200x630 PNG with EcoTicker branding:
   - Dark green/teal background
   - "EcoTicker" logo text
   - "Environmental Impact Tracker" subtitle
   - Can be created with any image tool; placeholder for US-6.3 dynamic images

### Phase 2: Create Topic Layout with generateMetadata (~45 lines)

**File:** `src/app/topic/[slug]/layout.tsx` (NEW)

**Changes:**

1. Create server component layout with `generateMetadata()`:
   ```typescript
   import type { Metadata } from "next";
   import { db } from "@/db";
   import { topics } from "@/db/schema";
   import { eq } from "drizzle-orm";

   interface Props {
     params: Promise<{ slug: string }>;
     children: React.ReactNode;
   }

   export async function generateMetadata({ params }: Props): Promise<Metadata> {
     const { slug } = await params;
     const rows = await db
       .select({
         name: topics.name,
         currentScore: topics.currentScore,
         urgency: topics.urgency,
         impactSummary: topics.impactSummary,
         scoreReasoning: topics.scoreReasoning,
       })
       .from(topics)
       .where(eq(topics.slug, slug))
       .limit(1);

     if (rows.length === 0) {
       return { title: "Topic Not Found — EcoTicker" };
     }

     const topic = rows[0];
     const description = (topic.impactSummary || topic.scoreReasoning || "Environmental impact tracker")
       .substring(0, 200);
     const title = `${topic.name} (Score: ${topic.currentScore}) — EcoTicker`;
     const url = `${process.env.NEXT_PUBLIC_BASE_URL || "https://ecoticker.app"}/topic/${slug}`;

     return {
       title,
       description,
       openGraph: {
         title,
         description,
         url,
         siteName: "EcoTicker",
         type: "article",
         images: [{ url: "/og-default.png", width: 1200, height: 630, alt: topic.name }],
       },
       twitter: {
         card: "summary_large_image",
         title,
         description,
         images: ["/og-default.png"],
       },
     };
   }

   export default function TopicLayout({ children }: Props) {
     return <>{children}</>;
   }
   ```

### Phase 3: Add Share Button to Topic Detail Page (~35 lines)

**File:** `src/app/topic/[slug]/page.tsx`

**Changes:**

1. Add share button state and handler inside `TopicDetailPage` component:
   ```typescript
   const [copied, setCopied] = useState(false);

   const handleShare = async () => {
     try {
       await navigator.clipboard.writeText(window.location.href);
       setCopied(true);
       setTimeout(() => setCopied(false), 2000);
     } catch {
       // Fallback: select and copy from a hidden input
       console.warn("Clipboard API not available");
     }
   };
   ```

2. Add share button in the header area (after the urgency badge / region, around line 121):
   ```tsx
   <button
     onClick={handleShare}
     className="text-sm px-3 py-1 rounded-lg border border-stone-300 dark:border-gray-600 text-stone-500 dark:text-gray-400 hover:bg-stone-100 dark:hover:bg-gray-800 transition-colors"
     data-testid="share-button"
   >
     {copied ? "Link copied!" : "Share"}
   </button>
   ```

3. The "Link copied!" text auto-fades after 2 seconds via the `setTimeout` in the handler.

### Phase 4: Add NEXT_PUBLIC_BASE_URL to Env (~2 lines)

**File:** `.env.example`

**Changes:**

1. Add base URL config:
   ```
   # Social sharing / OG tags
   NEXT_PUBLIC_BASE_URL=https://ecoticker.app
   ```

### Phase 5: Update Tests (~40 lines)

**File:** `tests/TopicDetail.test.tsx`

**Changes:**

1. Add test: "renders share button"
2. Add test: "copies URL to clipboard on share button click"
   ```typescript
   it("copies URL to clipboard on share button click", async () => {
     Object.assign(navigator, {
       clipboard: { writeText: jest.fn().mockResolvedValue(undefined) },
     });
     render(<TopicDetailPage />);
     await waitFor(() => screen.getByTestId("share-button"));
     fireEvent.click(screen.getByTestId("share-button"));
     expect(navigator.clipboard.writeText).toHaveBeenCalled();
   });
   ```
3. Add test: "shows 'Link copied!' after clicking share"

**File:** `tests/topic-layout.test.ts` (NEW — node environment)

**Changes:**

1. Test: "generateMetadata returns correct OG tags for existing topic"
2. Test: "generateMetadata returns fallback for missing topic"

### Phase 6: Verify & Validate

1. `npx tsc --noEmit` — no type errors
2. `npx jest` — full suite passes
3. Test OG tags with: `curl -s localhost:3000/topic/some-slug | grep 'og:'`
4. Test with social media debuggers (Twitter Card Validator, Facebook Sharing Debugger)
5. Verify share button copies URL and shows confirmation

---

## User Journeys

### Journey 1: Journalist — Sharing a topic on Twitter

1. Clara finds an interesting topic "Amazon Deforestation" on EcoTicker
2. Clicks the "Share" button on the topic detail page
3. Sees brief "Link copied!" confirmation
4. Pastes URL into a tweet
5. Twitter shows a rich preview card: topic name, score, impact summary, EcoTicker branding
6. Followers see the preview and understand the severity at a glance

### Journey 2: Journalist — Sharing via Slack

1. Clara copies the topic URL from address bar (or share button)
2. Pastes into a Slack channel
3. Slack unfurls the link with OG metadata: title with score, description, fallback image
4. Team can immediately see the topic's impact summary

---

## Files Changed Summary

| File | Action | Est. Lines |
|------|--------|------------|
| `src/app/topic/[slug]/layout.tsx` | Create | +45 |
| `src/app/topic/[slug]/page.tsx` | Modify | +20 |
| `public/og-default.png` | Create | — |
| `.env.example` | Modify | +2 |
| `tests/TopicDetail.test.tsx` | Modify | +25 |
| `tests/topic-layout.test.ts` | Create | +30 |

**Total estimated:** ~122 lines changed

## Risks

- **Next.js 16 metadata API:** `generateMetadata` in a layout (not page) is supported but less commonly documented. Verified it works with App Router.
- **DB call in layout:** Every topic page request triggers a lightweight DB query for metadata. Mitigated: single-row SELECT by indexed `slug` column — negligible overhead.
- **Static OG image:** Until US-6.3, all topics share the same preview image. Acceptable as an MVP.

## Definition of Done

- [ ] Topic pages have correct `og:title`, `og:description`, `og:image`, `og:url` meta tags
- [ ] Twitter card meta tags present (`twitter:card`, `twitter:title`, etc.)
- [ ] `<title>` includes topic name and score
- [ ] Share button copies URL to clipboard
- [ ] "Link copied!" confirmation appears for 2 seconds
- [ ] Static fallback OG image present at `/public/og-default.png`
- [ ] All new and existing tests pass
- [ ] TypeScript compiles without errors
