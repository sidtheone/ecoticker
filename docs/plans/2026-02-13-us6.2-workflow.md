# US-6.2 Implementation Workflow: Embeddable Live Topic Widget

**Date:** 2026-02-13
**Story:** US-6.2 — Embed a live topic widget on external websites
**Persona:** Blogger (external site owner)
**Branch:** `v2`
**Dependencies:** None
**Complexity:** M

---

## Current State Analysis

### What Exists

- Topic detail page at `src/app/topic/[slug]/page.tsx` — full-featured, includes navigation, chart, articles
- `Sparkline` component (`src/components/Sparkline.tsx`) — mini Recharts line chart, w-16 h-8
- `UrgencyBadge` component (`src/components/UrgencyBadge.tsx`) — color-coded urgency pill
- `urgencyColor()` and `scoreToUrgency()` utilities in `src/lib/utils.ts`
- `GET /api/topics/[slug]` returns topic data + score history (used by detail page)
- CSP middleware (`src/middleware.ts` line 37): sets `X-Frame-Options: SAMEORIGIN` — blocks embedding in iframes
- No embed route exists

### Problems to Solve / Key Design Decisions

1. **CSP for embed routes:** Must allow `X-Frame-Options` removal and `frame-ancestors *` for `/embed/*` paths while keeping SAMEORIGIN for all other routes.
2. **Minimal page:** Embed page must NOT include root layout's TickerBar, ThemeToggle, navigation. Decision: use a separate root layout for the embed route group.
3. **Theme via query param:** `?theme=dark|light` overrides system preference. Must apply theme class at render time.
4. **Auto-refresh:** Re-fetch topic data every 5 minutes to keep the widget live.
5. **Responsive sizing:** Default 300x150, but must look good at various iframe sizes.
6. **Embed code generation:** "Copy embed code" button on topic detail page provides an `<iframe>` snippet.

---

## Target State

- `/embed/[slug]` route renders a minimal widget: topic name, score (large, colored), urgency badge, sparkline
- Widget auto-refreshes every 5 minutes
- Theme controlled via `?theme=dark|light` query param
- CSP updated to allow framing for `/embed/*` routes
- "Copy embed code" button on topic detail page
- Designed for 300x150 default, responsive

---

## Implementation Phases

### Phase 1: Update CSP Middleware for Embed Routes (~15 lines)

**File:** `src/middleware.ts`

**Changes:**

1. Add embed path detection before setting security headers:
   ```typescript
   const isEmbedRoute = path.startsWith("/embed");

   // X-Frame-Options: allow embedding for /embed/* routes
   if (!isEmbedRoute) {
     response.headers.set('X-Frame-Options', 'SAMEORIGIN');
   }
   ```

2. Update CSP header to include `frame-ancestors` directive:
   ```typescript
   const frameAncestors = isEmbedRoute ? "frame-ancestors *;" : "frame-ancestors 'self';";
   response.headers.set(
     'Content-Security-Policy',
     `default-src 'self'; ` +
     `script-src 'self' 'unsafe-inline'; ` +
     `style-src 'self' 'unsafe-inline'; ` +
     `img-src 'self' data: https:; ` +
     `connect-src 'self'; ` +
     `font-src 'self' data:; ` +
     frameAncestors
   );
   ```

### Phase 2: Create Embed Layout (~25 lines)

**File:** `src/app/embed/layout.tsx` (NEW)

**Changes:**

1. Create a minimal layout with NO navigation, ticker, or theme toggle:
   ```typescript
   import type { Metadata } from "next";
   import "../globals.css";

   export const metadata: Metadata = {
     title: "EcoTicker Widget",
   };

   export default function EmbedLayout({ children }: { children: React.ReactNode }) {
     return (
       <html lang="en" suppressHydrationWarning>
         <body className="bg-transparent m-0 p-0 overflow-hidden">
           {children}
         </body>
       </html>
     );
   }
   ```

### Phase 3: Create Embed Widget Page (~80 lines)

**File:** `src/app/embed/[slug]/page.tsx` (NEW)

**Changes:**

1. Create the embed widget as a client component:
   ```typescript
   "use client";

   import { useEffect, useState } from "react";
   import { useParams, useSearchParams } from "next/navigation";
   import type { TopicDetail } from "@/lib/types";
   import { urgencyColor, scoreToUrgency } from "@/lib/utils";
   import Sparkline from "@/components/Sparkline";
   import UrgencyBadge from "@/components/UrgencyBadge";

   const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes

   export default function EmbedWidget() {
     const { slug } = useParams<{ slug: string }>();
     const searchParams = useSearchParams();
     const theme = searchParams.get("theme") || "light";

     const [data, setData] = useState<TopicDetail | null>(null);
     const [error, setError] = useState(false);

     useEffect(() => {
       const fetchData = async () => {
         try {
           const r = await fetch(`/api/topics/${slug}`);
           if (!r.ok) throw new Error("Not found");
           setData(await r.json());
         } catch {
           setError(true);
         }
       };

       fetchData();
       const interval = setInterval(fetchData, REFRESH_INTERVAL);
       return () => clearInterval(interval);
     }, [slug]);

     // Apply theme class
     useEffect(() => {
       if (theme === "dark") {
         document.documentElement.classList.add("dark");
       } else {
         document.documentElement.classList.remove("dark");
       }
     }, [theme]);

     if (error) return <div className="p-3 text-sm text-gray-400">Topic not found</div>;
     if (!data) return <div className="p-3 text-sm text-gray-400">Loading...</div>;

     const { topic, scoreHistory } = data;
     const sparklineData = scoreHistory.map((s) => s.score);
     const colors = urgencyColor(topic.urgency);

     return (
       <div className="p-3 h-full flex flex-col justify-between bg-white dark:bg-gray-900 rounded-lg border border-stone-200 dark:border-gray-700" data-testid="embed-widget">
         <div className="flex items-start justify-between gap-2">
           <div className="min-w-0">
             <div className="text-xs font-medium text-stone-500 dark:text-gray-400 truncate">{topic.name}</div>
             <div className={`text-3xl font-bold ${colors.text}`} data-testid="embed-score">{topic.currentScore}</div>
           </div>
           <UrgencyBadge urgency={topic.urgency} />
         </div>
         <div className="mt-2">
           <Sparkline data={sparklineData} />
         </div>
         <div className="text-[10px] text-stone-400 dark:text-gray-500 mt-1">
           Powered by EcoTicker
         </div>
       </div>
     );
   }
   ```

### Phase 4: Add "Copy Embed Code" Button to Topic Detail (~25 lines)

**File:** `src/app/topic/[slug]/page.tsx`

**Changes:**

1. Add embed copy state and handler (alongside existing share button logic):
   ```typescript
   const [embedCopied, setEmbedCopied] = useState(false);

   const handleCopyEmbed = async () => {
     const baseUrl = window.location.origin;
     const embedCode = `<iframe src="${baseUrl}/embed/${slug}" width="300" height="150" frameborder="0" style="border-radius:8px;"></iframe>`;
     try {
       await navigator.clipboard.writeText(embedCode);
       setEmbedCopied(true);
       setTimeout(() => setEmbedCopied(false), 2000);
     } catch {
       console.warn("Clipboard API not available");
     }
   };
   ```

2. Add embed button next to the share button:
   ```tsx
   <button
     onClick={handleCopyEmbed}
     className="text-sm px-3 py-1 rounded-lg border border-stone-300 dark:border-gray-600 text-stone-500 dark:text-gray-400 hover:bg-stone-100 dark:hover:bg-gray-800 transition-colors"
     data-testid="embed-button"
   >
     {embedCopied ? "Embed code copied!" : "Embed"}
   </button>
   ```

### Phase 5: Update Tests (~50 lines)

**File:** `tests/EmbedWidget.test.tsx` (NEW)

**Changes:**

1. Test: "renders topic name and score"
2. Test: "renders urgency badge"
3. Test: "renders sparkline"
4. Test: "applies dark theme class when ?theme=dark"
5. Test: "shows loading state initially"
6. Test: "shows error state for missing topic"
7. Test: "auto-refreshes data" (mock timers)

**File:** `tests/TopicDetail.test.tsx`

**Changes:**

1. Test: "renders embed button"
2. Test: "copies embed iframe code to clipboard"

**File:** `tests/middleware.test.ts` (if exists, or new)

**Changes:**

1. Test: "allows framing for /embed/* routes (no X-Frame-Options)"
2. Test: "keeps X-Frame-Options SAMEORIGIN for non-embed routes"

### Phase 6: Verify & Validate

1. `npx tsc --noEmit` — no type errors
2. `npx jest` — full suite passes
3. Open `/embed/some-slug` in browser — verify minimal widget renders
4. Open `/embed/some-slug?theme=dark` — verify dark theme applies
5. Embed in an `<iframe>` on a test HTML page — verify framing works
6. Verify non-embed pages still have `X-Frame-Options: SAMEORIGIN`

---

## User Journeys

### Journey 1: Blogger — Embedding a widget

1. Blogger visits EcoTicker topic page for "Great Barrier Reef Bleaching"
2. Clicks "Embed" button
3. Sees "Embed code copied!" confirmation
4. Pastes `<iframe>` snippet into their blog post HTML
5. Blog renders a live 300x150 widget showing score, urgency, sparkline
6. Widget auto-refreshes every 5 minutes with latest data

### Journey 2: Blogger — Dark theme widget

1. Blogger's site has a dark background
2. Modifies iframe src to add `?theme=dark`
3. Widget renders with dark theme matching their site design

---

## Files Changed Summary

| File | Action | Est. Lines |
|------|--------|------------|
| `src/middleware.ts` | Modify | +15 |
| `src/app/embed/layout.tsx` | Create | +25 |
| `src/app/embed/[slug]/page.tsx` | Create | +80 |
| `src/app/topic/[slug]/page.tsx` | Modify | +25 |
| `tests/EmbedWidget.test.tsx` | Create | +50 |
| `tests/TopicDetail.test.tsx` | Modify | +15 |

**Total estimated:** ~210 lines changed

## Risks

- **CSP frame-ancestors browser support:** `frame-ancestors` is widely supported but some very old browsers may ignore it. Acceptable for a modern web app.
- **Embed layout as a route group root layout:** In Next.js App Router, nested `layout.tsx` files compose, but the `/embed` route shares the root layout unless we use a route group. Decision: create `src/app/embed/layout.tsx` which Next.js will use as a nested layout. The root layout's TickerBar/ThemeToggle will still render. Alternative: use `(embed)` route group with its own root layout. This needs verification — if root layout chrome appears in embed, switch to route group approach.
- **API calls from iframe:** Same-origin, so no CORS issues. If deployed on a different subdomain, CORS must be configured.
- **Rate limiting:** Embed widgets auto-refresh from potentially many external sites. Each refresh hits the public GET API (100 req/min per IP). Since embeds share the user's browser IP, this is fine for typical usage.

## Definition of Done

- [ ] `/embed/[slug]` renders minimal widget (name, score, urgency badge, sparkline)
- [ ] Widget auto-refreshes every 5 minutes
- [ ] `?theme=dark|light` query param controls theme
- [ ] CSP allows framing for `/embed/*` routes only
- [ ] Non-embed routes retain `X-Frame-Options: SAMEORIGIN`
- [ ] "Copy embed code" button on topic detail page
- [ ] Widget is responsive, defaults to 300x150
- [ ] "Powered by EcoTicker" attribution shown
- [ ] All new and existing tests pass
- [ ] TypeScript compiles without errors
