# US-8.2 Implementation Workflow: Simple Analytics Dashboard

**Date:** 2026-02-13
**Story:** US-8.2 — View a simple analytics dashboard showing popular topics
**Persona:** Site Operator
**Branch:** `v2`
**Dependencies:** US-8.1 (view tracking API)
**Complexity:** M

---

## Current State Analysis

### What Exists

- Recharts already installed and used in `ScoreChart.tsx` for sparklines.
- Recharts mocking pattern established in tests (mock as simple divs with `data-testid`).
- Auth utilities: `requireAdminKey()` and `getUnauthorizedResponse()` in `src/lib/auth.ts`.
- US-8.1 provides `GET /api/admin/views?period=7d|30d|all` returning `{ period, topics: [...], dailyTotals: [...] }`.
- No `/admin/` pages exist yet in the app.
- Theme system uses class-based dark mode with warm cream/beige light and dark gray dark theme.

### Problems to Solve / Key Design Decisions

1. **Client-side auth for admin page**: Since this is a "use client" page, the API key must be provided somehow. Two options:
   - (a) Query param: `/admin/analytics?key=xxx` -- simple but exposes key in URL/logs.
   - (b) Prompt for key on page load, store in sessionStorage for the tab lifetime.
   - **Decision**: Use approach (b) -- prompt once, store in sessionStorage. Simple and avoids URL leakage.
2. **Recharts components**: Use `BarChart` (horizontal via `layout="vertical"`) for top topics, `LineChart` for daily totals.
3. **Responsive layout**: Charts stack vertically on mobile (`grid-cols-1`), side-by-side on desktop (`sm:grid-cols-2`).
4. **Period selector**: Simple button group toggling `7d`, `30d`, `all`.
5. **Table fallback**: Always shown below charts with exact numbers for accessibility.

---

## Target State

- Admin page at `/admin/analytics` prompts for API key, stores in sessionStorage.
- Fetches from `GET /api/admin/views?period=7d` (default) with `X-API-Key` header.
- Displays two Recharts visualizations: horizontal bar chart (top 10) and line chart (daily totals).
- Table below charts with exact numbers.
- Period toggle: 7d / 30d / all.
- Responsive: charts stack on mobile.

---

## Implementation Phases

### Phase 1: Analytics Page Component (~180 lines)

**File:** `src/app/admin/analytics/page.tsx`

**Changes:**

1. Create the "use client" admin analytics page:
```typescript
"use client";

import { useEffect, useState, useCallback } from "react";
import {
  BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer,
  LineChart, Line, CartesianGrid,
} from "recharts";

interface TopicViews {
  topicId: number;
  topicName: string;
  topicSlug: string;
  totalViews: number;
}

interface DailyTotal {
  date: string;
  totalViews: number;
}

type Period = "7d" | "30d" | "all";

export default function AnalyticsPage() {
  const [apiKey, setApiKey] = useState("");
  const [authenticated, setAuthenticated] = useState(false);
  const [period, setPeriod] = useState<Period>("7d");
  const [topicData, setTopicData] = useState<TopicViews[]>([]);
  const [dailyData, setDailyData] = useState<DailyTotal[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  // Check sessionStorage on mount
  useEffect(() => {
    const stored = sessionStorage.getItem("admin_api_key");
    if (stored) {
      setApiKey(stored);
      setAuthenticated(true);
    }
  }, []);

  const handleLogin = () => {
    sessionStorage.setItem("admin_api_key", apiKey);
    setAuthenticated(true);
  };

  const fetchData = useCallback(async () => {
    setLoading(true);
    setError("");
    try {
      const res = await fetch(`/api/admin/views?period=${period}`, {
        headers: { "X-API-Key": apiKey },
      });
      if (res.status === 401) {
        setAuthenticated(false);
        sessionStorage.removeItem("admin_api_key");
        setError("Invalid API key");
        return;
      }
      if (!res.ok) throw new Error("Failed to fetch");
      const data = await res.json();
      setTopicData(data.topics || []);
      setDailyData(data.dailyTotals || []);
    } catch {
      setError("Failed to load analytics data");
    } finally {
      setLoading(false);
    }
  }, [apiKey, period]);

  useEffect(() => {
    if (authenticated) fetchData();
  }, [authenticated, fetchData]);

  // ... render: auth prompt, period toggle, charts, table
}
```

2. **Auth prompt**: Simple input + button shown when `!authenticated`.
3. **Period toggle**: Three buttons with active state highlighting.
4. **Horizontal bar chart**: Top 10 topics by views using `BarChart` with `layout="vertical"`.
5. **Line chart**: Daily total views over the selected period.
6. **Table fallback**: Full list of topics with view counts.

### Phase 2: Layout File for Admin Section (~15 lines)

**File:** `src/app/admin/layout.tsx`

**Changes:**

1. Create a minimal layout wrapper for the admin section:
```typescript
export default function AdminLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="max-w-6xl mx-auto px-4 py-8">
      <h1 className="text-2xl font-bold text-stone-800 dark:text-white mb-6">
        Admin Dashboard
      </h1>
      {children}
    </div>
  );
}
```

### Phase 3: Verify & Validate

**Tests to write (~100 lines):**

**File:** `tests/AnalyticsPage.test.tsx`

1. Renders auth prompt when no key in sessionStorage.
2. After entering key, fetches data and renders charts container.
3. Period toggle changes fetch URL parameter.
4. Displays table with topic names and view counts.
5. Shows error message on 401 response and clears sessionStorage.
6. Responsive: charts render in grid layout.

**Manual verification:**
- Navigate to `/admin/analytics`, enter API key.
- Verify bar chart shows top topics, line chart shows daily trend.
- Toggle period, verify data refreshes.
- Resize browser, verify charts stack on mobile.

---

## User Journeys

### Journey 1: Site Operator — First visit to analytics

1. Operator navigates to `/admin/analytics`.
2. Sees "Enter API Key" prompt. Enters the admin key.
3. Key stored in sessionStorage. Page fetches 7-day view data.
4. Sees horizontal bar chart of top 10 topics and line chart of daily views.
5. Scrolls down to see exact numbers in a table.

### Journey 2: Site Operator — Explores different time periods

1. Operator clicks "30d" button in the period toggle.
2. Data refreshes with 30-day aggregation.
3. Bar chart and line chart update. Table updates.
4. Clicks "all" to see lifetime data.

### Journey 3: Site Operator — Returns to analytics in same tab

1. Operator navigates away, then back to `/admin/analytics`.
2. sessionStorage still has the key. Page auto-authenticates and loads data.

---

## Files Changed Summary

| File | Action | Est. Lines |
|------|--------|------------|
| `src/app/admin/analytics/page.tsx` | Create | ~180 |
| `src/app/admin/layout.tsx` | Create | ~15 |
| `tests/AnalyticsPage.test.tsx` | Create | ~100 |
| **Total** | | **~295** |

## Risks

- **sessionStorage key exposure**: Key is only in memory/sessionStorage (tab-scoped). Acceptable for admin tool.
- **Large dataset on "all" period**: If the site runs for years with many topics, the response could be large. Mitigated by only showing top 10 in chart; table could be paginated later.
- **Recharts SSR**: Page is "use client" so no SSR issues. Recharts renders only in browser.

## Definition of Done

- [ ] `/admin/analytics` page renders with API key prompt.
- [ ] After authentication, displays horizontal bar chart (top 10 topics by views).
- [ ] Displays line chart of daily total views over the selected period.
- [ ] Table fallback below charts shows exact numbers.
- [ ] Period toggle (7d / 30d / all) refreshes data.
- [ ] Responsive: charts stack on mobile.
- [ ] Data sourced from `GET /api/admin/views?period=...` with `X-API-Key` header.
- [ ] All new tests pass; existing tests unbroken.
- [ ] TypeScript compiles cleanly; build succeeds.
